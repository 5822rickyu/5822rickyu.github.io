!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).__MIRROR_REPORT__={})}(this,(function(e){"use strict";var t="2.0.10";const r="@bilibili/bili-mirror",n=t;let o=!1;function i(){return!1===o&&(o="undefined"!=typeof window),o}function s(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))}var a;"function"==typeof SuppressedError&&SuppressedError;const c=function(){if(i())return window}();function l(){if(i())return c.__biliMirror__=c.__biliMirror__||{},c.__biliMirror__}const u=i()&&(null===(a=document.getElementsByTagName("meta").spm_prefix)||void 0===a?void 0:a.content)||"0";function d(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e.addEventListener(t,r,n)}function h(){return Date.now()}const f=Object.prototype.toString;function p(e){return function(t){return f.call(t)===`[object ${e}]`}}const m={isNumber:p("Number"),isString:p("String"),isBoolean:p("Boolean"),isNull:p("Null"),isUndefined:p("Undefined"),isSymbol:p("Symbol"),isFunction:p("Function"),isObject:p("Object"),isArray:p("Array"),isProcess:p("process"),isWindow:p("Window")};function g(e){if(!e)return"";const t=String(e);try{return window.btoa(decodeURIComponent(encodeURIComponent(t)))}catch(e){return window.btoa(t.replace(/[^\x00-\x7F]/g,"_"))}}function v(e){const t=/^[0-9a-zA-Z_-]+$/.test(e);return t||console.warn(`[Mirror]:字符串:${e},不符合条件,任意数字,字母、下划线、中划线组成`),t}const w=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["chrome-extension"],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(0===t.length)return!1;if(null==(null==e?void 0:e.message))return!0;const[n]=e.message.split("?");if(n.includes(location.hostname))return!0;const o=(null==e?void 0:e.fileName)||"";if(r&&!o.endsWith(".js"))return!0;try{return t.map((e=>new RegExp(String.raw`${e}`))).some((e=>e.test(n)||e.test(o)))}catch(e){return console.error("Invalid regular expression:",e),!1}};function y(e){if("0"===e)return 0;if(m.isNumber(e))return e>10?10:e<=0?1:e;if(m.isString(e)&&!isNaN(e)){const t=parseInt(e);return t>10?10:t<=0?1:t}return console.warn("[Mirror]:[config] sampling rate error,please set 1-10"),1}function b(e){return Math.floor(10*Math.random()+1)>e}function R(){return"undefined"==typeof document||null==document.location?"":document.location.href}function E(e){if(!e)return{};const t=e.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!t)return{};const r=t[6]||"",n=t[8]||"";return{host:t[4],path:t[5],protocol:t[2],relative:t[5]+r+n}}function I(e,t,r){if(void 0!==e&&(t in e||arguments.length>3&&void 0!==arguments[3]&&arguments[3])){const n=r(e[t]);"function"==typeof n&&(e[t]=n)}}const O=(e,t)=>{let r=!0;return function(){if(r){for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];e.apply(this,o),r=!1,setTimeout((()=>{r=!0}),t)}}},S=(e,t)=>{let r;return function(){for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];clearTimeout(r),r=setTimeout((()=>{e.apply(this,o)}),t)}};function _(e){return e&&"object"==typeof e&&!Array.isArray(e)}function N(e,t){let r=Object.assign({},e);return _(e)&&_(t)&&Object.keys(t).forEach((n=>{_(t[n])?n in e?r[n]=N(e[n],t[n]):Object.assign(r,{[n]:t[n]}):Object.assign(r,{[n]:t[n]})})),r}const P=(e,t)=>{try{const r=e.split(".").map((e=>parseInt(e,10))),n=t.split(".").map((e=>parseInt(e,10)));for(let e=0;e<Math.max(r.length,n.length);e++){const t=e<r.length&&!isNaN(r[e])?r[e]:0,o=e<n.length&&!isNaN(n[e])?n[e]:0;if(t>o)return 1;if(t<o)return-1}return 0}catch(e){return console.warn("[Mirror] 版本比较失败:",e),0}},C={},T=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"__MIRROR_VERSION__",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(!i())return!0;if(r&&P(e,r)<0)return console.warn(`[Mirror]:当前SDK版本(${e})过低，低于最低支持版本${r}，将不会上报错误`),!1;if(!window[t])return window[t]=e,!0;const n=window[t],o=`${e}|${n}`;void 0===C[o]&&(C[o]=P(e,n));const s=C[o];return s>=0?(s>0&&(console.log(`[Mirror] 检测到更新的版本 ${e}，替换旧版本 ${n}`),window[t]=e,Object.keys(C).forEach((e=>{e.includes(n)&&delete C[e]}))),!0):(console.log(`[Mirror] 已存在更高版本 ${n}，当前版本 ${e} 将被忽略`),!1)};var k=function(e){"undefined"!=typeof window&&window.__BILI_X_ENGINE_SCRIPT_CACHE__&&void 0!==window.__BILI_X_ENGINE_SCRIPT_CACHE__[e]&&delete window.__BILI_X_ENGINE_SCRIPT_CACHE__[e]},M=function(e,t){if("undefined"==typeof window)return Promise.reject(new Error("window is not defined"));var r,n=e=e.replace(/^https?:\/\//,"//"),o=(r=n,"undefined"==typeof window?null:window.__BILI_X_ENGINE_SCRIPT_CACHE__&&window.__BILI_X_ENGINE_SCRIPT_CACHE__[r]||null);if(null!=o&&o.promise)return o.promise;var i=new Promise((function(r,n){var o=document.createElement("script");o.src=e,null!=t&&t.behavior&&o.setAttribute(t.behavior,""),o.onload=function(){var o=window;if(null!=t&&t.lib)return o[t.lib]?r(o[t.lib]):n(new Error('Failed to access library "'+t.lib+'" from '+e));r(null)},o.onerror=function(){n(new Error("Failed to load "+e)),document.head.removeChild(o)},document.head.appendChild(o)}));return function(e,t){"undefined"!=typeof window&&(window.__BILI_X_ENGINE_SCRIPT_CACHE__||(window.__BILI_X_ENGINE_SCRIPT_CACHE__={}),window.__BILI_X_ENGINE_SCRIPT_CACHE__[e]=t)}(n,{promise:i,lib:null==t?void 0:t.lib}),i.then((function(){!1===(null==t?void 0:t.cache)&&k(n)})).catch((function(){!1===(null==t?void 0:t.cache)&&k(n)})),i},L=function(e){return Promise.resolve(function(){try{return window.KvSDK?Promise.resolve(window.KvSDK):Promise.resolve(M("//s1.hdslb.com/bfs/seed/jinkela/kv-sdk/index.js",{lib:"KvSDK"}))}catch(e){return Promise.reject(e)}}()).then((function(t){return new t(e)}))},j=function(e){return Promise.resolve(function(){try{return window.ReporterPb?Promise.resolve(window.ReporterPb):Promise.resolve(M("//s1.hdslb.com/bfs/seed/jinkela/short/reporter-pb/index.js",{lib:"ReporterPb"}))}catch(e){return Promise.reject(e)}}()).then((function(t){return new t(e)}))};const x=l(),A={whiteList:{SPMID:"333.1333",GROUP:"bilimirror",KEY:"whitelist",KEYTOP:"toplist"},defaultConfig:{performance:1,poll:5,techpv:5,userLog:[],resourceTime:{},userLogDeep:10,track:{},filterEndJs:!1,limitDomain:[]}};class ${constructor(){this.origin="default",this.module="common",this.config={},this.kvOptions={},this.errorLevelsConfigSource="default",this.microAppErrorConfigSource="default"}fetchWhiteListConfig(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return s(this,void 0,void 0,(function*(){try{const n=yield e.get(t);return n?JSON.parse(n):(r||console.log(`[bili-Mirror]:${e.storage.appKey}-没有对应配置,返回默认配置`),r?A.defaultConfig:{})}catch(t){return console.warn(`[Mirror]:${e.storage.appKey},mirror获取白名单配置失败,返回默认配置`),A.defaultConfig}}))}getConfig(){return s(this,void 0,void 0,(function*(){const{SPMID:e,GROUP:t,KEY:r,KEYTOP:n}=A.whiteList,o=this.spmId||u;try{this._defaultConfigSDK=yield L(Object.assign({appKey:e,strict:1,reporter:{ignoreAppKeyNotFound:!0}},this.kvOptions));const[i,s]=yield Promise.all([this.fetchWhiteListConfig(this._defaultConfigSDK,`${t}.${r}`,!0),this.fetchWhiteListConfig(this._defaultConfigSDK,`${t}.${n}`,!0)]);let a={};e!==o&&(this._configSDK&&delete this._configSDK,this._configSDK=yield L(Object.assign({appKey:o,strict:1,reporter:{ignoreAppKeyNotFound:!0}},this.kvOptions)),a=yield this.fetchWhiteListConfig(this._configSDK,`${t}.${r}`));const c=N(N(i,a),s);this.updateConfig(c)}catch(e){console.error("Failed to get KV config:",e),this.updateConfig(A.defaultConfig)}}))}updateConfig(e){var t,r,n;(null==e?void 0:e.errorLevels)?this.errorLevelsConfigSource="kv":(null==this?void 0:this.localErrorLevels)&&Object.keys(this.localErrorLevels).length>0?this.errorLevelsConfigSource="local":this.errorLevelsConfigSource="default",(null==e?void 0:e.microAppError)?this.microAppErrorConfigSource="kv":(null==this?void 0:this.localMicroAppError)&&Object.keys(this.localMicroAppError).length>0?this.microAppErrorConfigSource="local":this.microAppErrorConfigSource="default",this.config={white:(null==e?void 0:e.white)||{},"white-performance-rate":y(null!==(t=null==e?void 0:e.performance)&&void 0!==t?t:1),"poll-time":y(null!==(r=null==e?void 0:e.poll)&&void 0!==r?r:5),"tech-pv":y(null!==(n=null==e?void 0:e.techpv)&&void 0!==n?n:5),"user-log":(null==e?void 0:e.userLog)||[],"resource-time":(null==e?void 0:e.resourceTime)||{},"user-log-deep":(null==e?void 0:e.userLogDeep)||10,track:(null==e?void 0:e.track)||{},"filter-end-js":(null==e?void 0:e.filterEndjs)||!1,"player-log-umd":(null==e?void 0:e.playLogUmd)||"","track-gray":(null==e?void 0:e.trackGrayV2)||0,"limit-control":(null==e?void 0:e.control)||{},"limit-domain":(null==e?void 0:e.limitDomain)||[],"error-levels":(null==e?void 0:e.errorLevels)||(null==this?void 0:this.localErrorLevels)||{},"micro-app-error":(null==e?void 0:e.microAppError)||(null==this?void 0:this.localMicroAppError)||{},"capture-config":(null==e?void 0:e.captureConfig)||{}}}bindOptions(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return s(this,void 0,void 0,(function*(){return x.mirrorVersion=n,Object.entries(e).forEach((t=>{let[r,n]=t;var o,i;(null===(o=null==e?void 0:e.config)||void 0===o?void 0:o.errorLevels)&&(this.localErrorLevels=e.config.errorLevels),(null===(i=null==e?void 0:e.config)||void 0===i?void 0:i.microAppError)&&(this.localMicroAppError=e.config.microAppError),"config"!==r&&(this[r]="module"===r&&"function"==typeof n?n():n)})),yield this.getConfig(),"ok"}))}}const D=i()?x.options||(x.options=new $):null;function B(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return s(this,void 0,void 0,(function*(){if(i()&&D)return yield D.bindOptions(e)}))}var H,F,U,W,q,G,K;!function(e){e.INIT="init",e.ERROR="error",e.UNHANDLEDREJECTION="unhandledrejection",e.RESOURCE="resource",e.PERFORMANCE="performance",e.WHITESCREEN="whiteScreen",e.BREABCRUMB="breadcrumb",e.BROWSER_REPORT="browser_report"}(H||(H={})),function(e){e.ERROR="error",e.CLICK="click",e.HISTORY="history",e.HASHCHANGE="hashchange",e.UNHANDLEDREJECTION="unhandledrejection",e.RESOURCE="resource",e.WHITE="white",e.CUSTOM="custom",e.SCROLL="scroll",e.API="request"}(F||(F={})),function(e){e.BEFORE="mirrorHandlerBefore",e.AFTER="mirrorHandlerAfter"}(U||(U={})),function(e){e.ERROR="error",e.OK="ok"}(W||(W={})),function(e){e.AUTO="auto",e.DEFAULT="default"}(q||(q={})),function(e){e.HISTORY="history",e.HASH="hash",e.DOM="dom",e.JS="js",e.PROMISE="promise",e.RESOURCE="resource",e.WHITE="white",e.SCROLL="scroll",e.API="request"}(G||(G={})),function(e){e.LOAD="info-load",e.REFRESH="info-refresh",e.PAGETABSTATUS="info-visibilitychange",e.DEVICE="info-device",e.SCROLL="info-scroll",e.PAGECLOSE="info-close",e.CLICK="info-click",e.HISTORY="info-history",e.HASHCHANGE="info-hashchange",e.APIUNKNOWN="info-request-unknown",e.APISUCCESS="success-request",e.APIERROR="error-request",e.ERROR="error-js",e.UNHANDLEDREJECTION="error-unhandledrejection",e.RESOURCE="error-resource",e.WHITE="error-white"}(K||(K={}));const V={isExclusive:1},J={mirrorPolymer:3},Q=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"before",r=arguments.length>2?arguments[2]:void 0;const n=[];let o=!1,i=0,a=!1;return{start(){return s(this,void 0,void 0,(function*(){if(o)throw new Error("队列已在运行中");o=!0,a=!1,i=0,n.length=0;try{for(;i<e.length&&!a;){const o=e[i];try{"before"===t?n.push(yield null==o?void 0:o.mirrorHandleBefore(r.type,r.data)):n.push(yield null==o?void 0:o.mirrorHandleAfter(r.type,r.data))}catch(e){console.error(`任务 ${i} 执行失败:`,e),n.push({error:e.message,index:i})}i++}return o=!1,n}catch(e){throw o=!1,e}}))},stop(){a=!0},reset:()=>{i=0,n.length=0,o=!1,a=!1},getStatus:()=>({isRunning:o,currentIndex:i,totalTasks:e.length,progress:e.length>0?Math.round(i/e.length*100):0})}};class z{constructor(){this.timeID=null,this.func=null,this.isRunning=!1}repeat(e,t){this.isRunning&&this.clear(),this.func=e,this.isRunning=!0;const r=()=>{if(this.isRunning){try{e()}catch(e){console.error("定时器执行失败:",e)}this.isRunning&&(this.timeID=setTimeout(r,t))}};this.timeID=setTimeout(r,t)}clear(){this.timeID&&(clearTimeout(this.timeID),this.timeID=null),this.isRunning=!1}isActive(){return this.isRunning}}let Y=null,X=null;const Z="BILI_MIRROR_REPORT_POOL";let ee=null,te=!1;const re=()=>6e4*((null==D?void 0:D.config["poll-time"])||3);let ne=re();(null==D?void 0:D.config["poll-time"])||setTimeout((()=>{const e=re();e!==ne&&(ne=e,X&&(X.clear(),X=new z,X.repeat(se,ne)))}),1e3);const oe=()=>{if(!ee)try{ee=JSON.parse(localStorage.getItem(Z)||"{}")}catch(e){console.error("读取上报池数据失败:",e),ee={}}return ee},ie=e=>{ee=e;try{localStorage.setItem(Z,JSON.stringify(e))}catch(e){console.error("保存上报池数据失败:",e)}},se=()=>{try{const e=oe();if(!Object.keys(e).length)return;if(!Y||"function"!=typeof Y.tech)return void console.warn("[Mirror]:上报器未初始化或不可用");Object.entries(e).forEach((e=>{let[t,r]=e;Y.tech(t,r)})),ee={},ie({})}catch(e){console.error("上报和清空上报池失败:",e)}},ae=()=>{X||(X=new z,X.repeat(se,ne),te||(d(c,"beforeunload",(function(){se(),ce()})),te=!0))},ce=()=>{Y&&"function"==typeof Y.flush&&Y.flush(),X&&(X.clear(),X=null),ee=null},le=["_GreyResult","_BiliGreyResult"],ue=le[1],de=()=>{const e=he("offline-version"),t=he("offline-name"),r=he("offline-plat"),n=he("offline-type");return e?{offlineVersion:e,offlineName:t,offlinePlat:r,offlineType:n}:{}},he=e=>{var t;return(null===(t=document.getElementsByTagName("meta")[e])||void 0===t?void 0:t.content)||void 0},fe=(()=>{if(!i())return{};let e=null,t=null;for(const r of le)if(c[r]){e=r,t=c[r];break}if(!e||!t)return{};var r={};Object.entries(t).forEach((e=>{let[t,n]=e;"grayVersion"===t?r[`${ue}_versionId`]=n:r[`${ue}_${t}`]=n}));const n=de();return Object.assign(Object.assign({},r),n)})(),pe="exposure",me="appear",ge="show",ve="custom",we="tech",ye=".DATA.successReport",be=".ERROR.errorReport",Re={feature:{tech:!0},extra:Object.assign(Object.assign({},fe),{mirrorVersion:t})},Ee=["spmPrefix","prefix"],Ie="[Mirror]: Not supported in server environment",Oe="[Mirror]: Report instance not available or invalid type",Se="[Mirror]: Tech report instance not available",_e="[Mirror]: Middleware instance not available",Ne="[Mirror]: Invalid options or missing msg field",Pe="[Mirror]: Cannot change report config - instance not initialized",Ce="[Mirror]: Failed to create reporter instance",Te="[Mirror]: Failed to load PB report script",ke="[Mirror Queue]",Me="[Mirror Helper]",Le="[Mirror Manager]";const je="MIRROR_TRACK_V2",xe="log",Ae="key",$e={createIndexedDB(){if(window.indexedDB)return new Promise(((e,t)=>{const r=indexedDB.open(je,1);r.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(xe)||t.createObjectStore(xe,{keyPath:Ae})},r.onsuccess=t=>{(null==t?void 0:t.target).result.close(),e()},r.onerror=()=>{console.log("Indexed Start Error"),t()}}))},add(e){if(!window.indexedDB)return;const t=function(){const e=new Date;return`${e.getFullYear()}-${1===String(e.getMonth()+1).length?"0"+(e.getMonth()+1):String(e.getMonth()+1)}-${1===String(e.getDate()).length?"0"+e.getDate():String(e.getDate())} ${1===String(e.getHours()).length?"0"+e.getHours():String(e.getHours())}:${1===String(e.getMinutes()).length?"0"+e.getMinutes():String(e.getMinutes())}:${1===String(e.getSeconds()).length?"0"+e.getSeconds():String(e.getSeconds())}`}()+"_"+Math.ceil(999*Math.random())+"Z",r=indexedDB.open(je,1);r.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(xe)||t.createObjectStore(xe,{keyPath:Ae})},r.onsuccess=r=>{const n=r.target.result;if(!n.objectStoreNames.contains(xe))return;const o=n.transaction(xe,"readwrite").objectStore(xe),i=o.count();i.onsuccess=()=>{o.put({[Ae]:t,log:e}),Number(i.result)<=5e3||(o.openCursor().onsuccess=e=>{const t=e.target.result;t&&t.delete()})},i.onerror=()=>{console.log("mirror indexDb count error")},n.close()},r.onerror=()=>{console.log("add Indexed Open Error")}},getAll(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(window.indexedDB)return new Promise(((t,r)=>{let n=[];const o=indexedDB.open(je);o.onsuccess=o=>{const i=o.target.result;if(!i.objectStoreNames.contains(xe))return void r(`the store log not exists in the ${je} dataBase`);const s=i.transaction(xe,"readonly").objectStore(xe);if(e)s.openCursor().onsuccess=e=>{var o,i;const s=e.target.result;if(s){const e=`${null===(o=s.value)||void 0===o?void 0:o.key}-${null===(i=s.value)||void 0===i?void 0:i.log}`;n.push(e),n.push("\r\n"),s.continue()}else if(0===n.length)r("No data in the store");else{const e=new Blob(n,{type:"text/plain;charset=utf-8"});t(e)}},s.openCursor().onerror=()=>{r("OpenCursor Error")};else{s.getAll().onsuccess=function(e){const r=e.target.result;t(r)}}i.close()},o.onerror=()=>{r("Indexed Open Error")}}))},clearStore(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:je,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:xe;if(!window.indexedDB)return;const r=indexedDB.open(e);r.onsuccess=e=>{const r=e.target.result;if(!r.objectStoreNames.contains(t))return;r.transaction(t,"readwrite").objectStore(t).clear().onsuccess=function(e){},r.close()},r.onerror=function(e){console.log("Error opening db",e.target.error)}},deleteIndexedDB(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:je;if(!window.indexedDB)return;const t=indexedDB.deleteDatabase(e);t.onsuccess=()=>{},t.onerror=()=>{console.log("Delete Error")}}};class De{static getInstance(){return this.instance||(this.instance=new De),this.instance}constructor(){}before(e,t){return new Promise((r=>s(this,void 0,void 0,(function*(){try{if(D.plugins&&m.isArray(D.plugins)){const n=D.plugins,o=(yield Q(n,"before",{type:e,data:t}).start()).some((e=>!0===e));r(o)}else if(D.plugins&&D.plugins.mirrorHandleBefore){const n=yield D.plugins.mirrorHandleBefore(e,t);r(!!n)}else r(!0)}catch(e){console.warn("[Mirror]:: plugin function before hook error, please check",e),r(!0)}}))))}after(e,t){return new Promise((r=>s(this,void 0,void 0,(function*(){try{if(D.plugins&&m.isArray(D.plugins)){const r=D.plugins;yield Q(r,"after",{type:e,data:t}).start()}else D.plugins&&D.plugins.mirrorHandleAfter&&(yield D.plugins.mirrorHandleAfter(e,t));r()}catch(e){console.warn("[Mirror]: plugin function after hook error, please check",e),r()}}))))}}De.instance=null;const Be=De.getInstance(),He=l();const Fe=i()?He.breadcrumb||(He.breadcrumb=new class{constructor(){this.maxBreadcrumbs=10,this.stack=[],this.isSet=!1,this.reportInProgress=!1,this.updateConfigFromOptions()}updateConfigFromOptions(){const e=null==D?void 0:D.config["user-log-deep"];e&&"number"==typeof e&&e>0&&(this.maxBreadcrumbs=e,this.isSet=!0)}hasError(){return this.stack.some((e=>"error"===e.status))}sanitizeData(e){const t=Object.assign({},e);return"string"==typeof t.message&&t.message.length>1e3&&(t.message=t.message.substring(0,1e3)+"...[截断]"),t.time=t.time||h(),this.removeCircularReferences(t),t}removeCircularReferences(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new WeakSet;if(!e||"object"!=typeof e)return e;if(t.has(e))return"[循环引用]";if(t.add(e),Array.isArray(e))return e.map((e=>this.removeCircularReferences(e,t)));const r={};for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&("function"==typeof e[n]?r[n]="[函数]":e[n]instanceof Node?r[n]=`[DOM:${e[n].nodeName}]`:r[n]=this.removeCircularReferences(e[n],t));return r}push(e){return s(this,void 0,void 0,(function*(){if(this.isSet||this.updateConfigFromOptions(),!this.reportInProgress)try{if(!(yield Be.before(H.BREABCRUMB,e)))return;const t=this.sanitizeData(e);this.immediatePush(t)}catch(e){console.error("Error in breadcrumb push:",e)}}))}immediatePush(e){this.stack.length>=this.maxBreadcrumbs&&(this.hasError()?this.goToReport([...this.stack]):this.clear()),this.stack.push(e),this.stack.length>1&&e.time<this.stack[this.stack.length-2].time&&this.stack.sort(((e,t)=>e.time-t.time))}clear(){this.stack=[]}getStack(){return[...this.stack]}goToReport(e){if(e&&e.length&&!this.reportInProgress){this.reportInProgress=!0;try{const t={};e.slice(0,Math.min(e.length,20)).forEach(((e,r)=>{t[`logStep-${r}`]=e})),wt({type:"custom",event:`${D.origin}.${D.module}.USERLOG`,msg:Object.assign({userLogInfo:Object.assign({},t)},V)}),Be.after(H.BREABCRUMB,e)}catch(e){console.error("Error in breadcrumb reporting:",e)}finally{this.clear(),this.reportInProgress=!1}}}}):null;let Ue=null;const We=l();function qe(e){const t=(null==D?void 0:D.config["user-log"])||null;return!!t&&t.find((t=>t===e))}function Ge(){return"log"!==(null==We?void 0:We.logType)}class Ke{constructor(){}handleHistory(e){const{from:t,to:r}=e,{relative:n}=E(t),{relative:o}=E(r);Ge()&&ot(K.HISTORY,"history跳转",{from:n||"/",to:o||"/",url:location.href}),qe(G.HISTORY)&&Fe.push({category:F.HISTORY,status:W.OK,time:h(),msg:{from:n||"/",to:o||"/"}})}handleHashChange(e){const{oldURL:t,newURL:r}=e,{relative:n}=E(t),{relative:o}=E(r);Ge()&&ot(K.HASHCHANGE,"hashChange跳转",{from:n,to:o,url:location.href}),qe(G.HASH)&&Fe.push({category:F.HASHCHANGE,status:W.OK,time:h(),msg:{from:n,to:o}})}handleDomClick(e){const t=function(e){const t=e.target.tagName.toLowerCase();if("html"===t||"body"===t)return"";let r=e.target.outerHTML;"path"===t&&(r=r.replace(/ d="[^"]*"/,""));const n=r.match(/<[^>]*>/),o=e.target.childNodes.length>0&&3===e.target.childNodes[0].nodeType?e.target.childNodes[0].nodeValue:"";return n?n[0]+o+"</"+t+">":""}(e);t&&(Ge()&&ot(K.CLICK,"点击",{dom:t,url:location.href}),qe(G.DOM)&&Fe.push({category:F.CLICK,status:W.OK,time:h(),msg:{clickDom:t}}))}handleScroll(){const e=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop;Ge()&&ot(K.SCROLL,"页面滚动",{top:e,url:location.href}),qe(G.SCROLL)&&Fe.push({category:F.SCROLL,status:W.OK,time:h(),msg:{top:e}})}handleJsError(e){Ge()&&ot(K.ERROR,"js报错",{message:e.message,url:location.href}),qe(G.JS)&&Fe.push({category:F.ERROR,status:W.ERROR,time:e.time||h(),msg:{message:e.message}})}handlePromiseError(e){Ge()&&ot(K.UNHANDLEDREJECTION,"rejection错误",{message:e.message,url:location.href}),qe(G.PROMISE)&&Fe.push({category:F.UNHANDLEDREJECTION,status:W.ERROR,time:e.time||h(),msg:{message:e.message}})}handleResourceError(e){Ge()&&ot(K.RESOURCE,"resource错误",{message:e.message,name:null==e?void 0:e.name,url:location.href}),qe(G.RESOURCE)&&Fe.push({category:F.RESOURCE,status:W.ERROR,time:e.time||h(),msg:{message:e.message,name:null==e?void 0:e.name}})}handleWhiteScreen(){Ge()&&ot(K.WHITE,"白屏错误",{url:location.href}),qe(G.WHITE)&&Fe.push({category:F.WHITE,status:W.ERROR,time:h(),msg:{url:location.href}})}handleRequest(e){var t,r,n,o;Ge()&&ot(Ve(e.httpCode),`请求httpCode:${e.httpCode}`,{api:null==e?void 0:e.api,traceId:(null===(t=null==e?void 0:e.headers)||void 0===t?void 0:t["X-Bili-Trace-Id"])||(null===(r=null==e?void 0:e.headers)||void 0===r?void 0:r["Bili-Trace-Id"])||"",code:null==e?void 0:e.code,message:null==e?void 0:e.msg,url:location.href}),qe(G.API)&&Fe.push({category:F.API,status:Ve(e.httpCode),time:h(),msg:{api:null==e?void 0:e.api,traceId:(null===(n=null==e?void 0:e.headers)||void 0===n?void 0:n["X-Bili-Trace-Id"])||(null===(o=null==e?void 0:e.headers)||void 0===o?void 0:o["Bili-Trace-Id"])||"",code:null==e?void 0:e.code,message:null==e?void 0:e.msg}})}}function Ve(e){return e?e>=200&&e<300?K.APISUCCESS:K.APIERROR:K.APIUNKNOWN}Ue||(Ue=new Ke);let Je=R();const Qe={historyReplace(){if(!function(){const e=c.chrome,t=e&&e.app&&e.app.runtime,r="history"in c&&!!c.history.pushState&&!!c.history.replaceState;return!t&&r}())return;const e=c.onpopstate;function t(e){return function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];const o=r.length>2?r[2]:void 0;if(o){const e=Je,t=String(o);Je=t,Ue.handleHistory({from:e,to:t})}return e.apply(this,r)}}c.onpopstate=function(){const t=R(),r=Je;Je=t,Ue.handleHistory({from:r,to:t});for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];e&&e.apply(this,o)},I(c.history,"pushState",t),I(c.history,"replaceState",t)},hashChangeReplace(){var e,t;e=c,t="onhashchange",Object.prototype.hasOwnProperty.call(e,t)&&d(c,"hashchange",(function(e){Ue.handleHashChange(e)}))},domClickReplace(){if(!("document"in c))return;const e=O(Ue.handleDomClick,300);d(c.document,"click",(function(t){e(t)}),!0)},scrollReplace(){const e=S(Ue.handleScroll,1e3);d(c,"scroll",(function(t){e(t)}),!0)},jsErrorReplace(e){null==Ue||Ue.handleJsError(e)},promiseErrorReplace(e){null==Ue||Ue.handlePromiseError(e)},resourceErrorReplace(e){null==Ue||Ue.handleResourceError(e)},whiteErrorReplace(){null==Ue||Ue.handleWhiteScreen()},apiReplace(e){null==Ue||Ue.handleRequest(e)}};function ze(e){return ze="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ze(e)}function Ye(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */Ye=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var i=t&&t.prototype instanceof v?t:v,s=Object.create(i.prototype),a=new T(n||[]);return o(s,"_invoke",{value:_(e,r,a)}),s}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",f="suspendedYield",p="executing",m="completed",g={};function v(){}function w(){}function y(){}var b={};l(b,s,(function(){return this}));var R=Object.getPrototypeOf,E=R&&R(R(k([])));E&&E!==r&&n.call(E,s)&&(b=E);var I=y.prototype=v.prototype=Object.create(b);function O(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){function r(o,i,s,a){var c=d(e[o],e,i);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==ze(u)&&n.call(u,"__await")?t.resolve(u.__await).then((function(e){r("next",e,s,a)}),(function(e){r("throw",e,s,a)})):t.resolve(u).then((function(e){l.value=e,s(l)}),(function(e){return r("throw",e,s,a)}))}a(c.arg)}var i;o(this,"_invoke",{value:function(e,n){function o(){return new t((function(t,o){r(e,n,t,o)}))}return i=i?i.then(o,o):o()}})}function _(t,r,n){var o=h;return function(i,s){if(o===p)throw Error("Generator is already running");if(o===m){if("throw"===i)throw s;return{value:e,done:!0}}for(n.method=i,n.arg=s;;){var a=n.delegate;if(a){var c=N(a,n);if(c){if(c===g)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===h)throw o=m,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var l=d(t,r,n);if("normal"===l.type){if(o=n.done?m:f,l.arg===g)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(o=m,n.method="throw",n.arg=l.arg)}}}function N(t,r){var n=r.method,o=t.iterator[n];if(o===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,N(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var i=d(o,t.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,g;var s=i.arg;return s?s.done?(r[t.resultName]=s.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,g):s:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}function P(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function C(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(P,this),this.reset(!0)}function k(t){if(t||""===t){var r=t[s];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return i.next=i}}throw new TypeError(ze(t)+" is not iterable")}return w.prototype=y,o(I,"constructor",{value:y,configurable:!0}),o(y,"constructor",{value:w,configurable:!0}),w.displayName=l(y,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,l(e,c,"GeneratorFunction")),e.prototype=Object.create(I),e},t.awrap=function(e){return{__await:e}},O(S.prototype),l(S.prototype,a,(function(){return this})),t.AsyncIterator=S,t.async=function(e,r,n,o,i){void 0===i&&(i=Promise);var s=new S(u(e,r,n,o),i);return t.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},O(I),l(I,c,"Generator"),l(I,s,(function(){return this})),l(I,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=k,T.prototype={constructor:T,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(C),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return a.type="throw",a.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var c=n.call(s,"catchLoc"),l=n.call(s,"finallyLoc");if(c&&l){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),C(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:k(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),g}},t}function Xe(e){return new Promise((function(t,r){var n=document.createElement("script");n.onload=function(){t(window[e.name]),n.remove()},n.onerror=r,n.src=e.url,document.head.appendChild(n)}))}function Ze(e){return t=this,r=null,n=Ye().mark((function t(){var r;return Ye().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Xe({name:"importShim",url:"https://s1.hdslb.com/bfs/static/dynamic-import/es-module-shims@1.9.0.js"});case 2:return r=t.sent,t.abrupt("return",r(e));case 4:case"end":return t.stop()}}),t)})),new Promise((function(e,o){var i=function(e){try{a(n.next(e))}catch(e){o(e)}},s=function(e){try{a(n.throw(e))}catch(e){o(e)}},a=function(t){return t.done?e(t.value):Promise.resolve(t.value).then(i,s)};a((n=n.apply(t,r)).next())}));var t,r,n}const et=l();function tt(e){const t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return t?decodeURIComponent(t[2]):null}function rt(){try{const e=null==D?void 0:D.config.track,t=null==D?void 0:D.config["track-gray"],r=tt("buvid3"),n=tt("DedeUserID");return!(!n||!function(e,t){if("string"==typeof t&&(t=parseFloat(t)),t<0||t>1)throw new Error("Rate must be between 0 and 1");return parseInt(null==e?void 0:e.substring(0,2),16)>256*t}(r,t))||!!e&&(0!==Object.keys(e).length&&(Array.isArray(null==e?void 0:e.mid)?(null==e?void 0:e.mid.includes(n))||(null==e?void 0:e.mid.includes("*")):!!Array.isArray(null==e?void 0:e.buvid)&&((null==e?void 0:e.buvid.includes(r))||(null==e?void 0:e.buvid.includes("*")))))}catch(e){return!1}}function nt(){const e=rt(),t=function(){var e;return null===(e=null==D?void 0:D.config["user-log"])||void 0===e?void 0:e.length}();return e&&t?"all":e&&!t?"track":!e&&t?"log":"none"}function ot(e,t,r){let n=`[${e}]: ${t} ${"string"==typeof r?r:JSON.stringify(r||"")}`;$e.add(n)}function it(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise(((r,n)=>s(this,void 0,void 0,(function*(){const o=new FormData;o.append("log",e),o.append("project",function(){const{spmId:e,origin:t,module:r}=et.options;return`${e||u}.${t}.${r}`}()),o.append("is_player_log",String(t));try{const e=yield fetch("https://api.bilibili.com/x/web-frontend/action-log/upload",{method:"POST",body:o,credentials:"include"});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=yield e.json();r(t)}catch(e){n("Failed to upload log: "+e)}}))))}function st(){return s(this,void 0,void 0,(function*(){try{if(!i())return;if(!window.indexedDB)return;if($e.deleteIndexedDB("MIRROR_TRACK"),et.logType=nt(),"none"===et.logType)return;"log"!==et.logType&&(yield $e.createIndexedDB(),function(){const e=tt("buvid3")||"-",t=tt("DedeUserID")||"-";let r=performance.getEntriesByType("navigation");if(r.length>0)if("reload"===r[0].type)ot(K.REFRESH,"页面刷新",{url:location.href,mid:t,buvid:e});else{ot(K.LOAD,"页面载入",{url:location.href,mid:t,buvid:e});const r=window.innerWidth,n=window.innerHeight;ot(K.DEVICE,"设备信息",{ua:navigator.userAgent,window_size:`${r}*${n}`,url:location.href})}c.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState?ot(K.PAGETABSTATUS,"选项卡被激活",{url:location.href}):"hidden"===document.visibilityState&&ot(K.PAGETABSTATUS,"选项卡被隐藏",{url:location.href})})),c.addEventListener("beforeunload",(()=>{ot(K.PAGECLOSE,"页面关闭",{url:location.href})}))}()),Qe.historyReplace(),Qe.hashChangeReplace(),Qe.domClickReplace(),Qe.scrollReplace()}catch(e){console.error("Failed to start tracking: "+e)}}))}function at(e,t){return new Promise(((r,n)=>s(this,void 0,void 0,(function*(){window.indexedDB?e?function(e){return s(this,void 0,void 0,(function*(){try{const{reportLogs:t}=yield Ze((null==D?void 0:D.config["player-log-umd"])||"https://s1.hdslb.com/bfs/static/log-manipulator@0.2.1/index.js");return new Promise(((r,n)=>{t("boolean"==typeof e?"all":e).then((e=>{if(e){const t=new Blob([e],{type:"text/plain;charset=utf-8"});r(it(t,!0))}n("log not found")}))}))}catch(e){console.error("Failed to upload play log: "+e)}}))}(e).then((()=>{r("player log upload success")})):new Promise(((e,t)=>{$e.getAll().then((r=>{it(r).then((t=>{e(t)})).catch((e=>{t(e)}))})).catch((e=>{t(e)}))})).then((()=>{if(t)return $e.clearStore("MIRROR_TRACK_V2","log"),void r("web log upload success, and clear db");r("web log upload success")})):n("not support indexedDB")}))))}const ct=new Map,lt=(e,t)=>{const r=t?`${e}:::${t}`:e;let n=ct.get(r);if(!n)try{if(n=new RegExp(e,t),ct.size>=1e3){const e=ct.keys().next().value;e&&ct.delete(e)}ct.set(r,n)}catch(t){console.warn(`Invalid regex pattern: ${e}`,t),n=/(?!)/}return n},ut={jsError:["message","fileName","stack","href"],resourceError:["message","name","href"],rejectionError:["message","fileName","stack","href"],apiError:["code","api","msg","message","method","httpCode","href"],whiteScreen:["href"]},dt=e=>{if(!i())return"record";const t=window.location.hostname,r=/bili/.test(t),n=/missevan/.test(t);return r||n?"major":"record"},ht=(e,t,r)=>{if(!e||!e.length)return;const n=e.find((e=>e.conditions&&e.conditions.length>0&&e.conditions.every((e=>((e,t,r)=>{const{field:n,operator:o,value:s}=e;if(!r.includes(n))return console.warn(`Field ${n} is not allowed in errorData.`),!1;let a;if(a="href"===n&&i()?window.location.href:t[n],null==a)return console.warn(`Field ${n} is undefined or null in errorData.`),!1;switch(o){case"=":return String(a)===String(s);case">":try{const e=Number(a),t=Number(s);return!isNaN(e)&&!isNaN(t)&&e>t}catch(e){return!1}case"<":try{const e=Number(a),t=Number(s);return!isNaN(e)&&!isNaN(t)&&e<t}catch(e){return!1}case">=":try{const e=Number(a),t=Number(s);return!isNaN(e)&&!isNaN(t)&&e>=t}catch(e){return!1}case"<=":try{const e=Number(a),t=Number(s);return!isNaN(e)&&!isNaN(t)&&e<=t}catch(e){return!1}case"contains":return"string"==typeof a&&String(a).includes(String(s));case"match":return"string"==typeof a&&lt(String(s)).test(a);default:return!1}})(e,t,r)))));return null==n?void 0:n.level},ft=(e,t)=>{var r;const n=t.split(".").pop()||"",o=null===(r=null==D?void 0:D.config)||void 0===r?void 0:r["error-levels"];if(!o||0===Object.keys(o).length)return dt();const i="errorReport"===n?"apiError":n,s=o[i],a=ut[i]||[];if(s&&s.length>0){const t=ht(s,e,a);if(t)return t}return dt()};const pt=new class{constructor(){this.taskQueue=[],this.isProcessing=!1,this.middlewareInstance=null,this.userInstanceName=""}enqueue(e){return s(this,void 0,void 0,(function*(){return new Promise(((t,r)=>{this.taskQueue.push((()=>s(this,void 0,void 0,(function*(){try{yield e(),t()}catch(e){r(e)}})))),this.processQueue()}))}))}setMiddlewareInstance(e){var t;this.middlewareInstance=e,t=this.middlewareInstance,Y!==t&&(Y=t)}getMiddlewareInstance(){return this.middlewareInstance}setUserInstanceName(e){this.userInstanceName=e}getUserInstanceName(){return this.userInstanceName}clear(){this.taskQueue=[],this.isProcessing=!1,this.middlewareInstance=null,this.userInstanceName=""}processQueue(){return s(this,void 0,void 0,(function*(){if(!this.isProcessing&&0!==this.taskQueue.length){this.isProcessing=!0;try{for(;this.taskQueue.length>0;){const e=this.taskQueue.shift();try{yield e()}catch(e){console.error(`${ke}: Task execution failed:`,e)}}}finally{this.isProcessing=!1}}}))}},mt=new class{constructor(){var e=this;this.loadPbReport=function(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!i())return Promise.reject(new Error(Ie));try{return t?e.loadMiddlewareInstance(r):e.loadMainInstance(r)}catch(e){return console.error(Te,e),Promise.reject(e)}}}getMirrorProject(e){if(!e)return"";const t=e.eventId||"",r=e.otherSpmId||(null==D?void 0:D.spmId)||u;return e.diyevent?t:`${r}.${t}`}customReport(e,t,r){if(!e||this.isLimitControl(e,"custom"))return;const n=this.transformReportParams(e),o=this.getMirrorProject(n),i=t.getUserInstanceName(),s=i?window[i]:window.__biliMirrorPbInstance__;if(s&&n.type)try{const e=r&&Object.keys(r).length>0,t=r&&this.shouldPassOptionsToReport(r);e&&!t&&this.changeReport(r),t?s[n.type](o,n.msg,r):s[n.type](o,n.msg)}catch(e){console.error(`${Me}: Custom report failed:`,e)}else console.warn(Oe)}techReport(e,t){if(!e||this.isLimitControl(e,"tech"))return;const{reportQueue:r,newOptions:n}=t,o=this.transformReportParams(e),i=this.getMirrorProject(o),s=r.getUserInstanceName(),a=s?window[s]:window.__biliMirrorPbInstance__;if(a)try{const e=Object.assign(Object.assign(Object.assign({},o.msg),fe),{mirrorVersion:Re.extra.mirrorVersion,type:o.type||ve}),t=n&&Object.keys(n).length>0,r=n&&this.shouldPassOptionsToReport(n);t&&!r&&this.changeReport(n),r?a[we](i,e,n):a[we](i,e)}catch(e){console.error(`${Me}: Tech report failed:`,e)}else console.warn(Se)}techReportPbForMiddleware(e,t,r){return e&&e.msg?new Promise(((n,o)=>{try{i=e.msg,"none"!==nt()&&Qe.apiReplace(i),!e.msg.message&&e.msg.msg&&(e.msg.message=e.msg.msg),r?(this.techReportPbMiddleware(e,t,r),n()):o(new Error("Manager instance required for enqueuing middleware task"))}catch(e){console.error(`${Me}: Middleware report failed:`,e),o(e)}var i})):Promise.reject(new Error(Ne))}techReportPbMiddleware(e,t,r){if(!r)return void console.warn(_e);const n=t||{},o=void 0!==n.isBatch&&n.isBatch,i=[n.spmId||u,n.origin||(null==D?void 0:D.origin),n.module||(null==D?void 0:D.module)].join(".");try{if(o)((e,t,r)=>{var n;const o=(null===(n=null==t?void 0:t.api)||void 0===n?void 0:n.split("?")[0])||"";try{const t=oe();t[e]||(t[e]=Object.assign(Object.assign({},r),J)),t[e][o]?t[e][o]++:t[e][o]=1,ie(t)}catch(e){console.error("添加到上报池失败:",e)}ae()})(i+(n.eventId||ye),e.msg,Object.assign({type:ve,mirrorVersion:Re.extra.mirrorVersion},fe));else{const t=ft(e.msg,be);r[we](i+(n.eventId||be),Object.assign(Object.assign({mirrorErrorLv:t,type:e.type||ve,mirrorVersion:Re.extra.mirrorVersion},e.msg),fe))}}catch(e){console.error(`${Me}: Middleware tech report execution failed:`,e)}}changeReport(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{feature:{tech:!0}};if(window.__biliMirrorPbInstance__)try{const t=window.__biliMirrorPbInstance__.options||{feature:{tech:!0}};window.__biliMirrorPbInstance__.options=Object.assign(Object.assign(Object.assign({},t),e),{feature:Object.assign(Object.assign({},t.feature),e.feature)})}catch(e){console.error(`${Me}: Failed to change report config:`,e)}else console.warn(Pe)}loadMiddlewareInstance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return new Promise(((t,r)=>{const n={feature:{tech:!0},autoPv:!1,batch:!1},o=e?Object.assign(Object.assign({},n),e):n;try{if(window.ReporterPb){const e=new window.ReporterPb(o);t(e)}else j(o).then((e=>t(e))).catch(r)}catch(e){console.error(`${Me}: Failed to create middleware instance:`,e),r(e)}}))}loadMainInstance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return new Promise(((t,r)=>{try{const n=(null==D?void 0:D.pbOtherNameIns)||"";if(m.isObject(window[n])&&Object.keys(window[n]).length)return console.warn(`${Me}: Using custom instance '${n}' for reporting. Please ensure [tech] config is enabled.`),void t();if(window.__biliMirrorPbInstance__)return void t();this.createReporterInstance(e).then((()=>t())).catch(r)}catch(e){console.error(`${Me}: Failed to load main instance:`,e),r(e)}}))}createReporterInstance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return new Promise(((t,r)=>{try{const n=(null==D?void 0:D.pbOptions)||{};let o={};e?o=N(N(Re,n),e):(o=N(Re,n),"0"===u&&D.spmId&&(o.spmPrefix=D.spmId),"0"!==u&&D.spmId&&u!==D.spmId&&console.warn(`${Me}: Detected spmId in page HTML. Please confirm if mirror-spmId config should be used (it will override the HTML spmId).`)),window.ReporterPb?(window.__biliMirrorPbInstance__=new window.ReporterPb(o),t()):j(o).then((e=>{window.__biliMirrorPbInstance__=e,t()})).catch(r)}catch(e){console.error(Ce,e),r(e)}}))}isLimitControl(e,t){var r;if(!e||!e.eventId&&!e.event)return!1;const n=e.eventId||e.event||"",o=null===(r=D.config)||void 0===r?void 0:r["limit-control"];if(!o||!Object.keys(o).length)return!1;const i="tech"===t?o.tech:o.custom;return!(!i||!i.length)&&i.some((e=>-1!==n.indexOf(e.key)&&b(e.val)))}transformReportParams(e){if(!e)return e;const t=Object.assign({},e);if(t.event&&!t.eventId&&(t.eventId=t.event),t.eventId&&!t.diyevent){t.eventId.split(".").length<=1&&(t.eventId=`${null==D?void 0:D.origin}.${null==D?void 0:D.module}.${t.eventId}`)}return t.type!==me&&t.type!==ge||(t.type=pe),t}shouldPassOptionsToReport(e){return!!e&&Ee.some((t=>e.hasOwnProperty(t)))}destroyReport(){try{window.__biliMirrorPbInstance__&&(window.__biliMirrorPbInstance__=null)}catch(e){console.error(`${Me}: Failed to destroy report instance:`,e)}}},gt=new class{constructor(e,t){this.pbInstance=null,this.techReportPb=(e,t)=>{this.queue.enqueue((()=>s(this,void 0,void 0,(function*(){try{yield this.helper.loadPbReport(!1),this.helper.techReport(e,{reportQueue:this.queue,newOptions:t})}catch(e){console.error(`${Le}: Tech report failed:`,e)}}))))},this.techReportPbForMiddleWare=(e,t)=>{const r=this.queue.getMiddlewareInstance();return this.helper.techReportPbForMiddleware(e,t,r).catch((r=>{if(r.message.includes("Manager instance required"))return this.enqueueMiddlewareTask(e,t),Promise.resolve();throw r}))},this.enqueueMiddlewareTask=(e,t)=>{this.queue.enqueue((()=>s(this,void 0,void 0,(function*(){try{const r=yield this.helper.loadPbReport(!0);this.queue.setMiddlewareInstance(r),this.helper.techReportPbMiddleware(e,t,r)}catch(e){console.error(`${Le}: Middleware task failed:`,e)}}))))},this.changeReport=e=>{this.helper.changeReport(e)},this.destroyReport=()=>{this.helper.destroyReport(),this.queue.clear(),this.pbInstance=null},this.getQueue=()=>this.queue,this.queue=e,this.helper=t}reportCustomPb(e,t){return s(this,void 0,void 0,(function*(){return this.queue.enqueue((()=>s(this,void 0,void 0,(function*(){try{yield this.ensurePbInstance(t),this.executeCustomReport(e,t)}catch(e){throw console.error(`${Le}: Custom report failed:`,e),e}}))))}))}ensurePbInstance(e){return s(this,void 0,void 0,(function*(){this.pbInstance||(this.pbInstance=yield this.helper.loadPbReport(!1,e))}))}executeCustomReport(e,t){this.helper.customReport(e,this.queue,t)}}(pt,mt);"undefined"!=typeof window&&(()=>{const e=(null==D?void 0:D.pbOtherNameIns)||"";m.isObject(window[e])&&Object.keys(window[e]).length&&pt.setUserInstanceName(e)})();const vt=(e,t)=>gt.reportCustomPb(e,t),wt=(e,t)=>gt.techReportPb(e,t),{loadPbReport:yt}=mt;var bt,Rt=-1,Et=function(e){addEventListener("pageshow",(function(t){t.persisted&&(Rt=t.timeStamp,e(t))}),!0)},It=function(){var e=self.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0];if(e&&e.responseStart>0&&e.responseStart<performance.now())return e},Ot=function(){var e=It();return e&&e.activationStart||0},St=function(e,t){var r=It(),n="navigate";return Rt>=0?n="back-forward-cache":r&&(document.prerendering||Ot()>0?n="prerender":document.wasDiscarded?n="restore":r.type&&(n=r.type.replace(/_/g,"-"))),{name:e,value:void 0===t?-1:t,rating:"good",delta:0,entries:[],id:"v4-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:n}},_t=function(e,t,r){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){var n=new PerformanceObserver((function(e){Promise.resolve().then((function(){t(e.getEntries())}))}));return n.observe(Object.assign({type:e,buffered:!0},r||{})),n}}catch(e){}},Nt=function(e,t,r,n){var o,i;return function(s){t.value>=0&&(s||n)&&((i=t.value-(o||0))||void 0===o)&&(o=t.value,t.delta=i,t.rating=function(e,t){return e>t[1]?"poor":e>t[0]?"needs-improvement":"good"}(t.value,r),e(t))}},Pt=function(e){requestAnimationFrame((function(){return requestAnimationFrame((function(){return e()}))}))},Ct=function(e){document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&e()}))},Tt=function(e){var t=!1;return function(){t||(e(),t=!0)}},kt=-1,Mt=function(){return"hidden"!==document.visibilityState||document.prerendering?1/0:0},Lt=function(e){"hidden"===document.visibilityState&&kt>-1&&(kt="visibilitychange"===e.type?e.timeStamp:0,xt())},jt=function(){addEventListener("visibilitychange",Lt,!0),addEventListener("prerenderingchange",Lt,!0)},xt=function(){removeEventListener("visibilitychange",Lt,!0),removeEventListener("prerenderingchange",Lt,!0)},At=function(){return kt<0&&(kt=Mt(),jt(),Et((function(){setTimeout((function(){kt=Mt(),jt()}),0)}))),{get firstHiddenTime(){return kt}}},$t=function(e){document.prerendering?addEventListener("prerenderingchange",(function(){return e()}),!0):e()},Dt=[1800,3e3],Bt=function(e,t){t=t||{},$t((function(){var r,n=At(),o=St("FCP"),i=_t("paint",(function(e){e.forEach((function(e){"first-contentful-paint"===e.name&&(i.disconnect(),e.startTime<n.firstHiddenTime&&(o.value=Math.max(e.startTime-Ot(),0),o.entries.push(e),r(!0)))}))}));i&&(r=Nt(e,o,Dt,t.reportAllChanges),Et((function(n){o=St("FCP"),r=Nt(e,o,Dt,t.reportAllChanges),Pt((function(){o.value=performance.now()-n.timeStamp,r(!0)}))})))}))},Ht=[.1,.25],Ft=0,Ut=1/0,Wt=0,qt=function(e){e.forEach((function(e){e.interactionId&&(Ut=Math.min(Ut,e.interactionId),Wt=Math.max(Wt,e.interactionId),Ft=Wt?(Wt-Ut)/7+1:0)}))},Gt=function(){return bt?Ft:performance.interactionCount||0},Kt=function(){"interactionCount"in performance||bt||(bt=_t("event",qt,{type:"event",buffered:!0,durationThreshold:0}))},Vt=[],Jt=new Map,Qt=0,zt=[],Yt=function(e){if(zt.forEach((function(t){return t(e)})),e.interactionId||"first-input"===e.entryType){var t=Vt[Vt.length-1],r=Jt.get(e.interactionId);if(r||Vt.length<10||e.duration>t.latency){if(r)e.duration>r.latency?(r.entries=[e],r.latency=e.duration):e.duration===r.latency&&e.startTime===r.entries[0].startTime&&r.entries.push(e);else{var n={id:e.interactionId,latency:e.duration,entries:[e]};Jt.set(n.id,n),Vt.push(n)}Vt.sort((function(e,t){return t.latency-e.latency})),Vt.length>10&&Vt.splice(10).forEach((function(e){return Jt.delete(e.id)}))}}},Xt=function(e){var t=self.requestIdleCallback||self.setTimeout,r=-1;return e=Tt(e),"hidden"===document.visibilityState?e():(r=t(e),Ct(e)),r},Zt=[200,500],er=function(e,t){"PerformanceEventTiming"in self&&"interactionId"in PerformanceEventTiming.prototype&&(t=t||{},$t((function(){var r;Kt();var n,o=St("INP"),i=function(e){Xt((function(){e.forEach(Yt);var t=function(){var e=Math.min(Vt.length-1,Math.floor((Gt()-Qt)/50));return Vt[e]}();t&&t.latency!==o.value&&(o.value=t.latency,o.entries=t.entries,n())}))},s=_t("event",i,{durationThreshold:null!==(r=t.durationThreshold)&&void 0!==r?r:40});n=Nt(e,o,Zt,t.reportAllChanges),s&&(s.observe({type:"first-input",buffered:!0}),Ct((function(){i(s.takeRecords()),n(!0)})),Et((function(){Qt=Gt(),Vt.length=0,Jt.clear(),o=St("INP"),n=Nt(e,o,Zt,t.reportAllChanges)})))})))},tr=[2500,4e3],rr={},nr=[800,1800],or=function e(t){document.prerendering?$t((function(){return e(t)})):"complete"!==document.readyState?addEventListener("load",(function(){return e(t)}),!0):setTimeout(t,0)},ir=function(e,t){t=t||{};var r=St("TTFB"),n=Nt(e,r,nr,t.reportAllChanges);or((function(){var o=It();o&&(r.value=Math.max(o.responseStart-Ot(),0),r.entries=[o],n(!0),Et((function(){r=St("TTFB",0),(n=Nt(e,r,nr,t.reportAllChanges))(!0)})))}))};const sr=[2500,4e3],ar=[200,500],cr=[.1,.25];function lr(e,t){let r=[];switch(e){case"LCP":r=sr;break;case"INP":r=ar;break;case"CLS":r=cr;break;default:return"good"}return t<=r[0]?"good":t<=r[1]?"needs-improvement":"poor"}function ur(e){if(!i())return;const t=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),r=/iphone|ipad|ipod/i.test(navigator.userAgent);Bt(e),ir(e),er(e),function(e,t){t=t||{},$t((function(){var r,n=At(),o=St("LCP"),i=function(e){t.reportAllChanges||(e=e.slice(-1)),e.forEach((function(e){e.startTime<n.firstHiddenTime&&(o.value=Math.max(e.startTime-Ot(),0),o.entries=[e],r())}))},s=_t("largest-contentful-paint",i);if(s){r=Nt(e,o,tr,t.reportAllChanges);var a=Tt((function(){rr[o.id]||(i(s.takeRecords()),s.disconnect(),rr[o.id]=!0,r(!0))}));["keydown","click"].forEach((function(e){addEventListener(e,(function(){return Xt(a)}),{once:!0,capture:!0})})),Ct(a),Et((function(n){o=St("LCP"),r=Nt(e,o,tr,t.reportAllChanges),Pt((function(){o.value=performance.now()-n.timeStamp,rr[o.id]=!0,r(!0)}))}))}}))}(e),function(e,t){t=t||{},Bt(Tt((function(){var r,n=St("CLS",0),o=0,i=[],s=function(e){e.forEach((function(e){if(!e.hadRecentInput){var t=i[0],r=i[i.length-1];o&&e.startTime-r.startTime<1e3&&e.startTime-t.startTime<5e3?(o+=e.value,i.push(e)):(o=e.value,i=[e])}})),o>n.value&&(n.value=o,n.entries=i,r())},a=_t("layout-shift",s);a&&(r=Nt(e,n,Ht,t.reportAllChanges),Ct((function(){s(a.takeRecords()),r(!0)})),Et((function(){o=0,n=St("CLS",0),r=Nt(e,n,Ht,t.reportAllChanges),Pt((function(){return r()}))})),setTimeout(r,0))})))}(e),function(e){var t;if(!i()||!(null===(t=window.performance)||void 0===t?void 0:t.getEntriesByType))return;const r=()=>{try{const t=window.performance,r=t.getEntriesByType("navigation")[0];if(!r)return;const n=Object.assign({},r.toJSON());delete n.serverTiming;const o=window._naToH5?{nativeContainerStartTime:window._naToH5.containerStartTime||window._naToH5.webviewInitTime||0,nativeContainerShowTime:window._naToH5.containerShowTime||window._naToH5.webviewLoadUrlTime||0,nativeLoadStartTime:window._naToH5.loadStartTime||0,nativeLoadFinishTime:window._naToH5.loadFinishTime||0}:{},i=Object.assign(Object.assign(Object.assign({_version:"2.0"},n),o),{pageStartTimeTs:t.timing.navigationStart});e({name:"PAGETIME",data:i,value:1})}catch(e){console.error("bili-mirror: 获取页面性能数据失败:",e)}};window.requestIdleCallback?window.requestIdleCallback(r,{timeout:1e3}):setTimeout(r,1e3)}(e),(r||t)&&(e=>{var t,r;if(i()&&window.performance)try{if(window.performance.timing){const t=window.performance.timing,r=t.domInteractive-t.navigationStart,n={name:"INP",value:r,navigationType:"navigate",rating:lr("INP",r),approximated:!0},o=t.domContentLoadedEventEnd-t.navigationStart,i={name:"LCP",value:o,navigationType:"navigate",rating:lr("LCP",o),approximated:!0};e(n),e(i)}if("function"==typeof window.requestAnimationFrame){let n=(null===(t=document.body)||void 0===t?void 0:t.offsetHeight)||0,o=(null===(r=document.body)||void 0===r?void 0:r.offsetWidth)||0,i=0,s=0;const a=50,c=()=>{var t,r;const l=(null===(t=document.body)||void 0===t?void 0:t.offsetHeight)||0,u=(null===(r=document.body)||void 0===r?void 0:r.offsetWidth)||0;if(n>0&&o>0){const e=Math.abs(l-n),t=Math.abs(u-o);if(e>0||t>0){const r=window.innerWidth*window.innerHeight,o=(e*window.innerWidth+t*n)/r;o>.001&&(i+=.01*o)}}if(n=l,o=u,s++,s>=a||i>.25){const t={name:"CLS",value:i,navigationType:"navigate",rating:lr("CLS",i),approximated:!0};e(t)}else window.requestAnimationFrame(c)};window.requestAnimationFrame(c)}}catch(e){console.error("bili-mirror: 基础性能指标收集失败:",e)}})(e)}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function dr(e,t){return e(t={exports:{}},t.exports),t.exports}var hr=dr((function(e,t){e.exports=function(){function e(e){return!isNaN(parseFloat(e))&&isFinite(e)}function t(e){return e.charAt(0).toUpperCase()+e.substring(1)}function r(e){return function(){return this[e]}}var n=["isConstructor","isEval","isNative","isToplevel"],o=["columnNumber","lineNumber"],i=["fileName","functionName","source"],s=["args"],a=["evalOrigin"],c=n.concat(o,i,s,a);function l(e){if(e)for(var r=0;r<c.length;r++)void 0!==e[c[r]]&&this["set"+t(c[r])](e[c[r]])}l.prototype={getArgs:function(){return this.args},setArgs:function(e){if("[object Array]"!==Object.prototype.toString.call(e))throw new TypeError("Args must be an Array");this.args=e},getEvalOrigin:function(){return this.evalOrigin},setEvalOrigin:function(e){if(e instanceof l)this.evalOrigin=e;else{if(!(e instanceof Object))throw new TypeError("Eval Origin must be an Object or StackFrame");this.evalOrigin=new l(e)}},toString:function(){var e=this.getFileName()||"",t=this.getLineNumber()||"",r=this.getColumnNumber()||"",n=this.getFunctionName()||"";return this.getIsEval()?e?"[eval] ("+e+":"+t+":"+r+")":"[eval]:"+t+":"+r:n?n+" ("+e+":"+t+":"+r+")":e+":"+t+":"+r}},l.fromString=function(e){var t=e.indexOf("("),r=e.lastIndexOf(")"),n=e.substring(0,t),o=e.substring(t+1,r).split(","),i=e.substring(r+1);if(0===i.indexOf("@"))var s=/@(.+?)(?::(\d+))?(?::(\d+))?$/.exec(i,""),a=s[1],c=s[2],u=s[3];return new l({functionName:n,args:o||void 0,fileName:a,lineNumber:c||void 0,columnNumber:u||void 0})};for(var u=0;u<n.length;u++)l.prototype["get"+t(n[u])]=r(n[u]),l.prototype["set"+t(n[u])]=function(e){return function(t){this[e]=Boolean(t)}}(n[u]);for(var d=0;d<o.length;d++)l.prototype["get"+t(o[d])]=r(o[d]),l.prototype["set"+t(o[d])]=function(t){return function(r){if(!e(r))throw new TypeError(t+" must be a Number");this[t]=Number(r)}}(o[d]);for(var h=0;h<i.length;h++)l.prototype["get"+t(i[h])]=r(i[h]),l.prototype["set"+t(i[h])]=function(e){return function(t){this[e]=String(t)}}(i[h]);return l}()})),fr=dr((function(e,t){var r,n,o,i;e.exports=(r=hr,n=/(^|@)\S+:\d+/,o=/^\s*at .*(\S+:\d+|\(native\))/m,i=/^(eval@)?(\[native code])?$/,{parse:function(e){if(void 0!==e.stacktrace||void 0!==e["opera#sourceloc"])return this.parseOpera(e);if(e.stack&&e.stack.match(o))return this.parseV8OrIE(e);if(e.stack)return this.parseFFOrSafari(e);throw new Error("Cannot parse given Error object")},extractLocation:function(e){if(-1===e.indexOf(":"))return[e];var t=/(.+?)(?::(\d+))?(?::(\d+))?$/.exec(e.replace(/[()]/g,""));return[t[1],t[2]||void 0,t[3]||void 0]},parseV8OrIE:function(e){return e.stack.split("\n").filter((function(e){return!!e.match(o)}),this).map((function(e){e.indexOf("(eval ")>-1&&(e=e.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""));var t=e.replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,""),n=t.match(/ (\(.+\)$)/);t=n?t.replace(n[0],""):t;var o=this.extractLocation(n?n[1]:t),i=n&&t||void 0,s=["eval","<anonymous>"].indexOf(o[0])>-1?void 0:o[0];return new r({functionName:i,fileName:s,lineNumber:o[1],columnNumber:o[2],source:e})}),this)},parseFFOrSafari:function(e){return e.stack.split("\n").filter((function(e){return!e.match(i)}),this).map((function(e){if(e.indexOf(" > eval")>-1&&(e=e.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1")),-1===e.indexOf("@")&&-1===e.indexOf(":"))return new r({functionName:e});var t=/((.*".+"[^@]*)?[^@]*)(?:@)/,n=e.match(t),o=n&&n[1]?n[1]:void 0,i=this.extractLocation(e.replace(t,""));return new r({functionName:o,fileName:i[0],lineNumber:i[1],columnNumber:i[2],source:e})}),this)},parseOpera:function(e){return!e.stacktrace||e.message.indexOf("\n")>-1&&e.message.split("\n").length>e.stacktrace.split("\n").length?this.parseOpera9(e):e.stack?this.parseOpera11(e):this.parseOpera10(e)},parseOpera9:function(e){for(var t=/Line (\d+).*script (?:in )?(\S+)/i,n=e.message.split("\n"),o=[],i=2,s=n.length;i<s;i+=2){var a=t.exec(n[i]);a&&o.push(new r({fileName:a[2],lineNumber:a[1],source:n[i]}))}return o},parseOpera10:function(e){for(var t=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,n=e.stacktrace.split("\n"),o=[],i=0,s=n.length;i<s;i+=2){var a=t.exec(n[i]);a&&o.push(new r({functionName:a[3]||void 0,fileName:a[2],lineNumber:a[1],source:n[i]}))}return o},parseOpera11:function(e){return e.stack.split("\n").filter((function(e){return!!e.match(n)&&!e.match(/^Error created at/)}),this).map((function(e){var t,n=e.split("@"),o=this.extractLocation(n.pop()),i=n.shift()||"",s=i.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^)]*\)/g,"")||void 0;i.match(/\(([^)]*)\)/)&&(t=i.replace(/^[^(]+\(([^)]*)\)$/,"$1"));var a=void 0===t||"[arguments not available]"===t?void 0:t.split(",");return new r({functionName:s,args:a,fileName:o[0],lineNumber:o[1],columnNumber:o[2],source:e})}),this)}})}));const pr=e=>{var t;const r=e.target;if(!r||e.target&&!(null===(t=e.target)||void 0===t?void 0:t.localName)){let t=fr.parse(r?e.error:e).slice(0,10),n=[];t.forEach((e=>{let{source:t}=e;const r=t?t.split(" ").join("").split("./"):"";n.push(r)}));let o=fr.parse(r?e.error:e)[0],{fileName:i,columnNumber:s,lineNumber:a}=o;return{type:"error",time:h(),message:e.message,fileName:i,line:a,column:s,stack:JSON.stringify(n)}}return null},mr=e=>{const t=e.target;if(null==t?void 0:t.localName){const e=function(e){return{time:h(),message:e.src||e.href||"",name:e.localName}}(t);return Object.assign(Object.assign({},e),{type:"resourceError"})}return null},gr=e=>{let t=fr.parse(e.reason).slice(0,10),r=[];t.forEach((e=>{let{source:t}=e;const n=t?t.split(" ").join("").split("./"):"";r.push(n)}));let n=fr.parse(e.reason)[0],{fileName:o,columnNumber:i,lineNumber:s}=n;var a;return{type:"rejectionError",time:h(),message:(a=e.reason.message||e.reason.stack,m.isString(a)?a:m.isUndefined(a)?"undefined":JSON.stringify(a)),fileName:o,line:s,column:i,stack:JSON.stringify(r)}};var vr;!function(e){e.ERROR="error",e.OK="ok"}(vr||(vr={}));class wr{constructor(){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.initCanvas()}initCanvas(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.zIndex="9999",document.body.appendChild(this.canvas)}drawCircle(e,t){this.context.beginPath(),this.context.arc(e,t,10,0,2*Math.PI),this.context.fill()}}class yr{constructor(e){this.whiteLoopNum=0,this.skeletonInitList=[],this.skeletonNowList=[],this.reportData={},this.styleData={},this.styleInfoCache=new Map,this.config=Object.assign({maxLoop:9},e),this.support=l(),e.debug&&(this.debugMode=new wr)}getSelector(e){return e.id?`#${e.id}`:e.className&&"string"==typeof e.className?"."+e.className.split(" ").filter(Boolean).join("."):e.nodeName.toLowerCase()}isContainer(e){const t=this.getSelector(e);this.config.isSkeleton&&(this.whiteLoopNum?this.skeletonNowList.push(t):this.skeletonInitList.push(t));return(this.config.checkDom||["html","body","#app"]).some((e=>t.match(e)))}getElementStyleInfo(e){var t;try{if(!e||!e.tagName)return this.getDefaultStyleInfo();if(this.styleInfoCache.has(e))return this.styleInfoCache.get(e);const r=window.getComputedStyle(e),n=e.getBoundingClientRect(),o={selector:this.getSelector(e),tagName:e.tagName.toLowerCase(),width:n.width,height:n.height,backgroundColor:r.backgroundColor,color:r.color,innerText:(null===(t=e.innerText)||void 0===t?void 0:t.substring(0,50))||"",hasChildren:e.children.length>0};return this.styleInfoCache.set(e,o),o}catch(e){return console.warn("[Mirror] getElementStyleInfo异常，已跳过样式信息收集:",e),this.getDefaultStyleInfo()}}getDefaultStyleInfo(){return{selector:"unknown",tagName:"unknown",width:0,height:0,backgroundColor:"transparent",color:"inherit",innerText:"",hasChildren:!1}}checkPoint(e,t,r){return s(this,void 0,void 0,(function*(){const n=document.elementsFromPoint(e,t),o=n.map((e=>this.getSelector(e))),i=n.some((e=>this.isContainer(e)));if(i)this.reportData[r]=o;else try{const e=n.length>0&&n[0]?[this.getElementStyleInfo(n[0])]:[this.getDefaultStyleInfo()];this.reportData[r]=o,this.styleData[r]=e}catch(e){console.warn("[Mirror] 样式信息收集失败，跳过该检测点的样式数据:",e),this.reportData[r]=o,this.styleData[r]=[this.getDefaultStyleInfo()]}return this.debugMode&&this.debugMode.drawCircle(e,t),i}))}samplePlan(){return s(this,void 0,void 0,(function*(){if(!(null===document||void 0===document?void 0:document.elementsFromPoint))return void console.warn("[Mirror]:当前浏览器不支持elementsFromPoint方法,白屏检测跳过");if(!(yield Be.before(H.WHITESCREEN)))return;this.styleInfoCache.clear();let e=!1;for(let t=1;t<=9;t++){const r=window.innerWidth*t/10,n=window.innerHeight/2;if(e=yield this.checkPoint(r,n,`pointX-${t}`),e)break;if(5!==t){const r=window.innerWidth/2,n=window.innerHeight*t/10;if(e=yield this.checkPoint(r,n,`pointY-${t}`),e)break}}if(this.reportData.check_list=this.config.checkDom||["html","body","#app"],e){if(this.config.isSkeleton){if(!this.whiteLoopNum)return void this.startLoop();if(this.skeletonNowList.join()===this.skeletonInitList.join())return void this.handleResult(vr.ERROR)}this.support._loopTimer&&clearTimeout(this.support._loopTimer),this.support._loopTimer=null}else this.startLoop();this.handleResult(e?vr.OK:vr.ERROR)}))}handleResult(e){var t,r;const n={status:e,loop:this.whiteLoopNum,data:Object.assign({},this.reportData)};null===(r=(t=this.config).callback)||void 0===r||r.call(t,n),this.whiteLoopNum>=this.config.maxLoop&&this.reportWhiteScreen(),Be.after(H.WHITESCREEN,Object.assign({},this.reportData))}reportWhiteScreen(){var e;const t=ft({},"whiteScreen"),r=g(`白屏错误-${Date.now()}-${D.origin}.${D.module}-${Math.ceil(999*Math.random())}`);wt({type:"error",eventId:`${D.origin}.${D.module}.ERROR.whiteScreen`,msg:{mirrorErrorLv:t,_BiliCheckDom_Point:Object.assign({},this.reportData),_BiliCheckDom_Style:Object.assign({},this.styleData),_BiliCheckDom_List:null===(e=this.reportData)||void 0===e?void 0:e.check_list,_BiliErrorId:r}}),Qe.whiteErrorReplace(),this.isCanCapture()&&this.htmlToCanvasImage(r),this.clearCache()}clearCache(){this.styleInfoCache.clear(),this.reportData={},this.styleData={},this.skeletonInitList=[],this.skeletonNowList=[]}htmlToCanvasImage(e){try{const t=document.createElement("script");t.src="https://s1.hdslb.com/bfs/seed/jinkela/short/html2canvas/html2canvas.min.js",t.onload=()=>{"undefined"!=typeof html2canvas?html2canvas(document.documentElement,{allowTaint:!0,useCORS:!0,logging:!1}).then((t=>{this.canvasToBlob(t,e)})).catch((e=>{console.error("[Mirror]:html2canvas渲染失败",e)})):console.error("[Mirror] html2canvas加载失败")},t.onerror=()=>{console.error("[Mirror]:白屏截图库加载失败")},document.head.appendChild(t)}catch(e){console.error("生成白屏截图失败",e)}}isCanCapture(){const{captureGrayScreenRate:e,capturerScreenEndTs:t}=this.config||{},{captureGrayScreenRate:r,capturerScreenEndTs:n}=D.config["capture-config"]||{},o=e||r,i=t||n;return!!o&&(!(i&&Date.now()>i)&&!b(o))}canvasToBlob(e,t){e.toBlob((e=>{if(e){const r=new FormData,n=new File([e],`screenshot-${Date.now()}.png`,{type:"image/png"}),o=(null==D?void 0:D.spmId)||u;r.append("image",n),r.append("project",`${o}.${D.origin}.${D.module}`),r.append("report_id",t),fetch("https://api.bilibili.com/x/web-frontend/action-log/upload-image",{method:"POST",body:r,credentials:"include"}).then((e=>{if(!e.ok)throw new Error(`[Mirror] :upload white screen image failed: ${e.status}`);return e.json()})).then((e=>{})).catch((e=>{console.error("[Mirror] :upload white screen image failed",e)}))}}),"image/png")}startLoop(){if(this.whiteLoopNum>=this.config.maxLoop&&this.support._loopTimer)return clearTimeout(this.support._loopTimer),void(this.support._loopTimer=null);this.support._loopTimer=setTimeout((()=>{this.whiteLoopNum++,this.config.isSkeleton&&(this.skeletonNowList=[]),this.samplePlan()}),1e3)}start(){this.config.isSkeleton?"complete"!==document.readyState&&this.samplePlan():"complete"===document.readyState?this.samplePlan():c.addEventListener("load",(()=>this.samplePlan()))}}function br(e){new yr(e).start()}const Rr=["message","stack"],Er=(e,t,r,n,o)=>{if("resourceError"===o&&"message"!==e)return!1;if("resourceError"!==o&&!Rr.includes(e))return!1;if(null==n)return!1;switch(t){case"=":return String(n)===String(r);case"match":try{return lt(String(r)).test(String(n))}catch(e){return console.warn(`[Mirror:]Invalid regex in micro-app match condition: ${r}`,e),!1}case"contains":return String(n).includes(String(r));default:return!1}},Ir=(e,t,r,n,o)=>{if(!e||!Array.isArray(e))return!1;for(const i of e){const{condition:e,origin:s,module:a}=i;if(!e)continue;if(e.every((e=>{const{field:n,operator:o,value:i}=e,s=t[n];return Er(n,o,i,s,r)}))){return`${s||n}.${a||o}.ERROR.${r}`}}return!1},Or=(e,t)=>{var r;const n=t.split(".").pop()||"";if(!["jsError","rejectionError","resourceError"].includes(n))return!1;const o=null===(r=null==D?void 0:D.config)||void 0===r?void 0:r["micro-app-error"];if(!o)return!1;var i;if(i=o,Array.isArray(i)?i.length>0&&i.every((e=>"string"==typeof e.origin&&"string"==typeof e.module)):i&&"string"==typeof i.origin&&"string"==typeof i.module){if(Array.isArray(o)){for(const t of o){const{origin:r,module:o}=t,i=t[n];if(i&&Array.isArray(i)){const t=Ir(i,e,n,r,o);if(t)return t}}return!1}{const{origin:t,module:r}=o,i=o[n];if(i&&Array.isArray(i))return Ir(i,e,n,t,r)}}else{const t=o[n];if(t&&Array.isArray(t))return((e,t,r)=>{if(!e||!Array.isArray(e))return!1;for(const n of e){const{condition:e,origin:o,module:i}=n;if(e&&o&&i&&e.every((e=>{const{field:n,operator:o,value:i}=e,s=t[n];return Er(n,o,i,s,r)})))return`${o}.${i}.ERROR.${r}`}return!1})(t,e,n)}return!1},Sr=[];let _r=!1;const Nr=()=>({js_event:`${D.origin}.${D.module}.ERROR.jsError`,resource_event:`${D.origin}.${D.module}.ERROR.resourceError`,unhandledrejection_event:`${D.origin}.${D.module}.ERROR.rejectionError`,performance_event:`${D.origin}.${D.module}.PERFORMANCE`,browser_report_event:`${D.origin}.${D.module}.BROWSER.report`}),Pr=e=>{const t=g((null==e?void 0:e.message)||(null==e?void 0:e.fileName));return Sr.includes(t)?(console.warn(`[Mirror]:Duplicate error, not reported, ${null==e?void 0:e.message}`),!1):(Sr.push(t),!0)},Cr=()=>{var e,t,r,n;const o=(null!==(e=null==c?void 0:c.screen.width)&&void 0!==e?e:0)<=100||(null!==(t=null==c?void 0:c.screen.height)&&void 0!==t?t:0)<=100||(null!==(r=null==c?void 0:c.innerWidth)&&void 0!==r?r:0)<=100||(null!==(n=null==c?void 0:c.innerHeight)&&void 0!==n?n:0)<=100;return _r||o||Tr()},Tr=()=>{var e,t,r;const n=(null===(e=null==D?void 0:D.config)||void 0===e?void 0:e["limit-domain"])||[];if(n.length){if(!n.some((e=>location.href.includes(e))))return!0}const o=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(0===e.length)return!1;try{return e.some((e=>new RegExp(String.raw`${e}`).test(navigator.userAgent)))}catch(e){return!1}}(null===(r=null===(t=null==D?void 0:D.config)||void 0===t?void 0:t.white)||void 0===r?void 0:r.ua);return!!o},kr={_reportEvent(e,t,r){var n;return s(this,void 0,void 0,(function*(){if(!(yield Be.before(e,t)))return;const o=e===H.PERFORMANCE,i=e===H.BROWSER_REPORT,s=!o&&!i,a=s?ft(t,r):void 0,c=s?Or(t,r):null,l=c||r,u=D.errorLevelsConfigSource,d=D.microAppErrorConfigSource;wt({type:o?"performance":"error",eventId:l,msg:o?t:i?Object.assign(Object.assign({},t),{reportSource:"browser-native",reportCategory:"reporting-api"}):Object.assign(Object.assign({},t),{mirrorErrorLv:a,isMicroApp:!!c,errorLevelsConfigSource:a?u:void 0,microAppErrorConfigSource:c?d:void 0})},null!==(n=D.pbOptions)&&void 0!==n?n:{}),Be.after(e,t)}))},handleError(e){return s(this,void 0,void 0,(function*(){if(Cr())return;const t=e.target;try{!t||e.target&&!e.target.localName?yield this.handlerJsErrorFn(e):(null==t?void 0:t.localName)&&(yield this.handlerResourceErrorFn(e))}catch(t){console.warn("[Mirror]: 无法解析的错误:",e.message||"未知错误")}}))},handlerJsErrorFn(e){var t,r,n;return s(this,void 0,void 0,(function*(){const o=pr(e),i=null===(r=null===(t=null==D?void 0:D.config)||void 0===t?void 0:t.white)||void 0===r?void 0:r.error,s=(null===(n=null==D?void 0:D.config)||void 0===n?void 0:n["filter-end-js"])||!1;!w(o,i,s)&&Pr(o)&&(this._reportEvent(H.ERROR,o,Nr().js_event),Qe.jsErrorReplace(o))}))},handlerResourceErrorFn(e){var t,r;return s(this,void 0,void 0,(function*(){const n=mr(e);if(!n||!n.message.trim().length)return;const o=null===(r=null===(t=null==D?void 0:D.config)||void 0===t?void 0:t.white)||void 0===r?void 0:r.resource;!w(n,o)&&Pr(n)&&(this._reportEvent(H.RESOURCE,n,Nr().resource_event),Qe.resourceErrorReplace(n))}))},unhandRejection(e){var t,r,n;return s(this,void 0,void 0,(function*(){try{if(Cr())return;const o=gr(e),i=null===(r=null===(t=null==D?void 0:D.config)||void 0===t?void 0:t.white)||void 0===r?void 0:r.rejection,s=(null===(n=null==D?void 0:D.config)||void 0===n?void 0:n["filter-end-js"])||!1;!w(o,i,s)&&Pr(o)&&(this._reportEvent(H.UNHANDLEDREJECTION,o,Nr().unhandledrejection_event),Qe.promiseErrorReplace(o))}catch(t){console.warn("[Mirror]: Promise拒绝错误解析失败:",e.reason&&"object"==typeof e.reason?e.reason.message||String(e.reason):String(e.reason)||"未知Promise拒绝错误(解析失败)")}}))},handlePerformance(){return s(this,void 0,void 0,(function*(){try{if(Cr())return;if(b(D.config["white-performance-rate"]))return;ur((e=>s(this,void 0,void 0,(function*(){var t,r;let{name:n,value:o}=e;if(!o||o<0)return;const i="approximated"in e&&!0===e.approximated,s="data"in e?Object.assign({},e.data):Object.assign({},e);if(i&&(s.approximated=!0),"LCP"===e.name&&"entries"in e){const n=e.entries[0],o=null==n?void 0:n.element;if(o){const e={type:o.tagName.toLowerCase(),className:(null===(r=null===(t=o.className)||void 0===t?void 0:t.split(" "))||void 0===r?void 0:r[0])||"",src:"img"===o.tagName.toLowerCase()?o.src:""};s.lcpInfo=e}}"entries"in s&&delete s.entries,this._reportEvent(H.PERFORMANCE,s,`${Nr().performance_event}.${n}`)}))))}catch(e){console.warn("[Mirror]:: performance-Error parsing failed:",e)}}))},handleWhiteScreen(e){try{if(Cr())return;br(e.whiteScreen)}catch(e){console.error("bili-mirror: whiteScreen错误解析异常:",e)}},handleBeforeUnload(){_r=!0}};"undefined"!=typeof window&&window.addEventListener("beforeunload",kr.handleBeforeUnload);const Mr=()=>(T(n,"__MIRROR_VERSION__")||console.warn("[Mirror] 检测到更高版本正在运行，当前版本将继续工作但建议统一版本"),!0),Lr=()=>{var e;return!!(null===(e=null==D?void 0:D.config)||void 0===e?void 0:e.ignoreErrorReport)&&(console.warn("[Mirror]: API方法不可用，ignoreErrorReport 配置为 true"),!0)},jr=(e,t)=>{i()&&Mr()&&!Lr()&&vt(e,t)},xr=(e,t)=>{i()&&Mr()&&!Lr()&&wt(e,t)},Ar=e=>{var t;i()&&Mr()&&!Lr()&&(t=e,gt.changeReport(t))},$r=(e,t)=>{i()&&Mr()&&!Lr()&&vt({type:"pv",eventId:"0.0",msg:e,otherSpmId:t||null})},Dr=e=>i()&&Mr()&&!Lr()&&v(e.key)?new Promise((t=>{wt({type:"custom",eventId:e.eventId,diyevent:!0,msg:Object.assign(Object.assign({exclusiveFrom:(null==e?void 0:e.key)||""},e.msg),V)}),t()})):Promise.resolve(),Br=(e,t)=>i()&&Mr()&&!Lr()?((e,t)=>gt.techReportPbForMiddleWare(e,t))(e,t):Promise.resolve(),Hr=e=>{if(!i()||!Mr()||Lr())return;if(!v(e.name))return;const t=`${D.origin}.${D.module}.PERFORMANCE.${e.name}`;wt({type:"performance",eventId:t,msg:{name:e.name,value:e.value}})},Fr=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return!Mr()||Lr()?Promise.resolve([]):at(e,t)},Ur=(e,t,r)=>{Mr()&&!Lr()&&ot(e,t,r)},Wr=()=>!Mr()||Lr()?Promise.resolve([]):$e.getAll(!1),qr=e=>{Mr()&&!Lr()&&kr.handleError(e)},Gr=e=>{Mr()&&!Lr()&&kr.handleError(e)};var Kr=Object.freeze({__proto__:null,customReportPb:jr,techReportPb:xr,changePbOptions:Ar,pbReportPv:$r,exclusiveBisReport:Dr,canBatchTechReport:Br,customPerformanceQuota:Hr,trackLogReport:Fr,trackCustomLog:Ur,trackGetLog:Wr,_mirrorHandleErrorReport:qr,errorBoundary:Gr});let Vr=null;const Jr=["xmlhttprequest","fetch","img","image","link","css","video","iframe","script"],Qr={API:"xmlhttprequest,fetch",IMG:"img,image",CSS:"link,css",JS:"script",VIDEO:"video",IFRAME:"iframe"};const zr=i()?new class{constructor(){this.regexCache=new Map,this.config=D.config["resource-time"]||{},this.resourceWaitList=[],this.disablePush=!1}on(){D.config["resource-time"]&&(this.config=D.config["resource-time"],0!==Object.keys(this.config).length&&PerformanceObserver&&(null===PerformanceObserver||void 0===PerformanceObserver?void 0:PerformanceObserver.supportedEntryTypes)&&(this._getAllData(),this._createObserver()))}destroy(){Vr&&(Vr.disconnect(),Vr=null),this.resourceWaitList=[],this.regexCache.clear()}_getAllData(){const e=performance.getEntriesByType("resource");(e||e.length)&&(e.forEach((e=>{this.resourceWaitList.push(e)})),this._handlerResourceInit())}_handlerResourceInit(){this.disablePush=!0;for(;this.resourceWaitList.length;){const e=this.resourceWaitList.splice(0,10).filter((e=>this._isCheckResource(e))).map((e=>this._computeResourceData_(e)));e.length&&this._waitRequest(e)}this.disablePush=!1}_waitRequest(e){"requestIdleCallback"in window?window.requestIdleCallback((()=>{this._reportResourceTime(e)})):setTimeout((()=>{this._reportResourceTime(e)}),0)}_reportResourceTime(e){wt({type:"performance",eventId:`${D.origin}.${D.module}.PERFORMANCE.RESOURCETIME`,msg:e})}_isCheckResource(e){if(!Jr.includes(e.initiatorType))return!1;if(!Object.keys(this.config).length)return!1;for(let t in this.config){if(!this.config[t])continue;if(Qr[t].split(",").includes(e.initiatorType)&&(Array.isArray(this.config[t])&&this.config[t].length)){const r=e.name;if(this.config[t].some((t=>{let n=this.regexCache.get(t);return n||(n=new RegExp(t),this.regexCache.set(t,n)),!!n.test(r)&&(e.ruleGroup=t,!0)})))return!0}}return!1}_computeResourceData_(e){const t=e.name.split("?"),{startTime:r,domainLookupStart:n,domainLookupEnd:o,connectStart:i,connectEnd:s,secureConnectionStart:a,requestStart:c,responseStart:l,responseEnd:u,transferSize:d,initiatorType:h,duration:f,nextHopProtocol:p,redirectStart:m,redirectEnd:g}=e;return{_version:"1.0",group:e.ruleGroup||"",url:t[0],query:t[1]||"",size:d,type:h,protocol:p,timeline_duration:Number(f.toFixed(0)),timeline_startTime:Number(r.toFixed(0)),timeline_domainLookupStart:Number(n.toFixed(0)),timeline_domainLookupEnd:Number(o.toFixed(0)),timeline_connectStart:Number(i.toFixed(0)),timeline_connectEnd:Number(s.toFixed(0)),timeline_secureConnectionStart:Number(a.toFixed(0)),timeline_requestStart:Number(c.toFixed(0)),timeline_responseStart:Number(l.toFixed(0)),timeline_responseEnd:Number(u.toFixed(0)),timeline_redirectStart:Number(m.toFixed(0)),timeline_redirectEnd:Number(g.toFixed(0))}}_createObserver(){try{Vr=new PerformanceObserver((e=>{try{if(e.getEntries().forEach((e=>{this.resourceWaitList.push(e.toJSON())})),this.disablePush)return;this._handlerResourceInit()}catch(e){console.error("处理性能条目时出错:",e)}})),Vr.observe({entryTypes:["resource"]})}catch(e){console.error("创建性能观察器时出错:",e)}}}:null;function Yr(){if(!window.ReportingObserver||!i())return;if(!(Math.random()<.01))return;let e=null;try{e=new ReportingObserver((e=>{e.forEach((e=>{const t={reportingType:e.type,url:e.url,body:e.body,source:"reporting-api"};window.requestIdleCallback?window.requestIdleCallback((()=>kr._reportEvent(H.BROWSER_REPORT,t,Nr().browser_report_event))):setTimeout((()=>kr._reportEvent(H.BROWSER_REPORT,t,Nr().browser_report_event)),0)}))}),{types:["deprecation","intervention","crash"],buffered:!0}),e.observe(),function(e){Xr.push(e)}(e)}catch(e){console.warn("[Mirror]: Reporting API initialization failed:",e)}}let Xr=[];function Zr(){i()&&(Xr.forEach((e=>{try{e.disconnect()}catch(e){console.warn("[Mirror]: Failed to disconnect ReportingObserver:",e)}})),Xr=[],zr&&zr.destroy(),c.removeEventListener("error",kr.handleError),c.removeEventListener("unhandledrejection",kr.unhandRejection))}function en(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{if(!i())return;if(e.ignoreErrorReport)return void console.warn("[Mirror]:停止捕获错误上报，请确认配置的ignoreErrorReport是否正确");if(e.ignoreVersion&&"string"==typeof e.ignoreVersion){if(P(n,e.ignoreVersion)<=0)return void console.warn(`[Mirror]:当前SDK版本(${n})小于等于配置的忽略版本(${e.ignoreVersion})，停止捕获错误上报`)}if(Array.isArray(e.ignorePageVersion)&&e.ignorePageVersion.length){const t=(()=>{if(!i())return{};for(const e of le){const t=c[e];if(t){if(t.versionId)return t.versionId;if(t.grayVersion)return t.grayVersion}}})(),r=Number(t);if(!isNaN(r)){const t=e.ignorePageVersion.some((e=>{const t=Number(e);return!isNaN(t)&&t===r}));if(t)return void console.warn("[Mirror]:当前页面版本在忽略版本列表中，停止捕获错误上报")}}d(c,"error",(function(e){window.requestIdleCallback?window.requestIdleCallback((()=>kr.handleError(e))):setTimeout((()=>kr.handleError(e)),0)}),!0),d(c,"unhandledrejection",(function(e){window.requestIdleCallback?window.requestIdleCallback((()=>kr.unhandRejection(e))):setTimeout((()=>kr.unhandRejection(e)),0)})),setTimeout((()=>{kr.handlePerformance()}),0),function(e){if(null==e?void 0:e.whiteScreen)try{kr.handleWhiteScreen(e)}catch(e){console.error("bili-mirror: whiteScreen错误解析异常:",e)}}(e),function(){const e=D.config["resource-time"];if(e&&Object.keys(e).length)try{zr.on()}catch(e){zr.destroy(),console.warn("[Mirror]:resource-watch error",e)}}(),Yr(),"undefined"!=typeof window&&window.addEventListener("beforeunload",Zr)}catch(e){console.error("[Mirror] stepInit failed:",e)}}let tn=null;class rn{constructor(){this.checkInterval=null,this.checkTimeout=null,this.safeOverwriteSignatures=["polyfill","shim","ponyfill","compatibility","wrapper","helper"],this.criticalMethods=["eval","setTimeout","setInterval","fetch","XMLHttpRequest","addEventListener","removeEventListener","postMessage","localStorage","sessionStorage","HTMLCanvasElement.prototype.toDataURL"],this.methodsInfo=new Map}init(){if(i())try{this.initMethodsMonitoring()}catch(e){console.error("Mirror method monitor initialization failed:",e)}}getPropertyByPath(e,t){const r=t.split(".");let n=e;for(const e of r){if(null==n)return;n=n[e]}return n}initMethodsMonitoring(){this.criticalMethods.forEach((e=>{try{if(e.includes(".")){const t=this.getPropertyByPath(window,e);"function"==typeof t&&this.recordMethodInfo(e,t)}else e in window&&"function"==typeof window[e]&&this.recordMethodInfo(e,window[e])}catch(t){console.error(`Error initializing monitor for ${e}:`,t)}}))}recordMethodInfo(e,t){try{const r=this.safeToString(t);this.methodsInfo.set(e,{isNative:this.isNativeMethod(t,r),lastChecked:Date.now(),overwrittenCount:0,isOverwritten:!1})}catch(t){console.error(`Error recording method info for ${e}:`,t)}}safeToString(e){try{return Function.prototype.toString.call(e)}catch(e){return""}}isNativeMethod(e,t){return t.includes("[native code]")}isSafeOverwrite(e){return this.safeOverwriteSignatures.some((t=>e.toLowerCase().includes(t)))}isMethodMaliciouslyOverwritten(e){try{const t=this.methodsInfo.get(e);if(!t)return!1;let r;if(r=e.includes(".")?this.getPropertyByPath(window,e):window[e],"function"!=typeof r)return!0;const n=this.safeToString(r);return!!t.isNative&&(!n.includes("[native code]")&&!this.isSafeOverwrite(n))}catch(t){return console.error(`Error checking method ${e}:`,t),!1}}checkOverwrittenMethods(){this.methodsInfo.forEach(((e,t)=>{try{const r=this.isMethodMaliciouslyOverwritten(t);r!==e.isOverwritten&&(e.isOverwritten=r,r&&(e.overwrittenCount++,this.reportOverwrittenMethod(t,e))),e.lastChecked=Date.now()}catch(e){console.error(`Error in check cycle for ${t}:`,e)}}))}reportOverwrittenMethod(e,t){wt({type:"error",eventId:`${D.origin}.${D.module}.ERROR.METHOD_OVERWRITE`,msg:{url:window.location.href,method:e,overwrittenCount:t.overwrittenCount,timestamp:Date.now()}})}startCheck(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5e3,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6e4;null===this.checkInterval&&null===this.checkTimeout?(this.checkOverwrittenMethods(),this.checkInterval=window.setInterval((()=>this.checkOverwrittenMethods()),e),t>0&&(this.checkTimeout=window.setTimeout((()=>this.stopCheck()),t))):console.warn("Method monitor check is already running.")}stopCheck(){null!==this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null),null!==this.checkTimeout&&(clearTimeout(this.checkTimeout),this.checkTimeout=null)}getMethodsStatus(){return Object.fromEntries(this.methodsInfo)}}try{!tn&&i()&&(tn=new rn)}catch(e){console.error("bili-mirror:MethodMonitor init error:",e)}const nn=new Map,on=new Map;function sn(e,t){if(e.diyevent)return e.eventId;const r=e.eventId||e.event||"unknown";if(r.split(".").length>2)return r;return`${t.origin||(null==D?void 0:D.origin)||"default"}.${t.module||(null==D?void 0:D.module)||"common"}.${r}`}function an(e){const t=()=>on.get(e)||{};return{techReportPb:(e,r)=>{const n=t(),o=Object.assign(Object.assign({},e),{eventId:sn(e,n),otherSpmId:n.spmId||e.otherSpmId});return xr(o,r)},customReportPb:(e,r)=>{const n=t(),o=Object.assign(Object.assign({},e),{eventId:sn(e,n),otherSpmId:n.spmId||e.otherSpmId});return jr(o,r)},customPerformanceQuota:e=>{const r=t(),n=`${r.origin||(null==D?void 0:D.origin)||"default"}.${r.module||(null==D?void 0:D.module)||"common"}.PERFORMANCE.${e.name}`;return xr({type:"performance",eventId:n,otherSpmId:r.spmId,msg:{name:e.name,value:e.value}})},pbReportPv:(e,r)=>{const n=t().spmId||r;return $r(e,n)},changePbOptions:Ar,canBatchTechReport:Br,exclusiveBisReport:Dr,trackLogReport:Fr,trackCustomLog:Ur,trackGetLog:Wr,_mirrorHandleErrorReport:qr,errorBoundary:Gr}}class cn{constructor(e,t){this.listeners=[],this.isInitialized=!1,this.instanceName=e,this.config=t}initialize(){return s(this,void 0,void 0,(function*(){if(this.isInitialized)console.warn(`[Mirror] 实例 ${this.instanceName} 已经初始化，跳过重复初始化`);else try{yield this.initErrorHandlers(),yield this.initPerformanceMonitoring(),yield this.initWhiteScreenDetection(),this.isInitialized=!0,console.info(`[Mirror] 实例 ${this.instanceName} 监控初始化完成`)}catch(e){throw console.error(`[Mirror] 实例 ${this.instanceName} 初始化失败:`,e),e}}))}initErrorHandlers(){var e;return s(this,void 0,void 0,(function*(){if(null===(e=this.config.config)||void 0===e?void 0:e.ignoreErrorReport)return void console.info(`[Mirror] 实例 ${this.instanceName} 已禁用错误上报`);this.addListener(c,"error",(e=>{this.handleInstanceError(e)}),!0),this.addListener(c,"unhandledrejection",(e=>{this.handleInstanceRejection(e)}))}))}initPerformanceMonitoring(){var e;return s(this,void 0,void 0,(function*(){(null===(e=this.config.config)||void 0===e?void 0:e["white-performance-rate"])&&setTimeout((()=>{this.handleInstancePerformance()}),0)}))}initWhiteScreenDetection(){var e;return s(this,void 0,void 0,(function*(){if(null===(e=this.config.config)||void 0===e?void 0:e.whiteScreen)try{const e={debug:this.config.config.whiteScreen.debug,maxLoop:this.config.config.whiteScreen.maxLoop,checkDom:this.config.config.whiteScreen.checkDom||[`#${this.instanceName}`,".micro-app-root"],isSkeleton:Boolean(this.config.config.whiteScreen.isSkeleton),captureGrayScreenRate:this.config.config.whiteScreen.captureGrayScreenRate,capturerScreenEndTs:this.config.config.whiteScreen.capturerScreenEndTs,callback:e=>{this.handleInstanceWhiteScreenResult(e)}};br(e),console.info(`[Mirror] 实例 ${this.instanceName} 白屏检测已启动，监控区域:`,e.checkDom)}catch(e){console.error(`[Mirror] 实例 ${this.instanceName} 白屏检测初始化失败:`,e)}}))}handleInstanceError(e){const t=e.target;try{!t||e.target&&!e.target.localName?this.handleInstanceJSError(e):(null==t?void 0:t.localName)&&this.handleInstanceResourceError(e)}catch(e){console.warn(`[Mirror] 实例 ${this.instanceName} 错误处理失败:`,e)}}handleInstanceRejection(e){try{const t=gr(e);if(t){an(this.instanceName).techReportPb({type:"error",eventId:"rejectionError",msg:Object.assign(Object.assign({},t),{instanceName:this.instanceName})})}}catch(e){console.warn(`[Mirror] 实例 ${this.instanceName} Promise rejection处理失败:`,e)}}handleInstancePerformance(){ur((e=>s(this,void 0,void 0,(function*(){const{name:t,value:r}=e;if(!r||r<0)return;const n=an(this.instanceName),o="data"in e?Object.assign({},e.data):Object.assign({},e);o.instanceName=this.instanceName,n.customPerformanceQuota(Object.assign({name:t,value:r},o))}))))}handleInstanceJSError(e){const t=pr(e);if(t){an(this.instanceName).techReportPb({type:"error",eventId:"jsError",msg:Object.assign(Object.assign({},t),{instanceName:this.instanceName})})}}handleInstanceResourceError(e){const t=mr(e);if(t){an(this.instanceName).techReportPb({type:"error",eventId:"resourceError",msg:Object.assign(Object.assign({},t),{instanceName:this.instanceName})})}}handleInstanceWhiteScreenResult(e){var t,r,n,o;if(e.status===vr.ERROR&&e.loop>=((null===(r=null===(t=this.config.config)||void 0===t?void 0:t.whiteScreen)||void 0===r?void 0:r.maxLoop)||9)){an(this.instanceName).techReportPb({type:"error",eventId:"whiteScreen",msg:{status:e.status,loop:e.loop,data:e.data,instanceName:this.instanceName,checkDom:(null===(o=null===(n=this.config.config)||void 0===n?void 0:n.whiteScreen)||void 0===o?void 0:o.checkDom)||[`#${this.instanceName}`]}})}}addListener(e,t,r,n){e.addEventListener(t,r,n),this.listeners.push({target:e,event:t,handler:r})}destroy(){return s(this,void 0,void 0,(function*(){this.listeners.forEach((e=>{let{target:t,event:r,handler:n}=e;t.removeEventListener(r,n)})),this.listeners=[],this.isInitialized=!1,console.info(`[Mirror] 实例 ${this.instanceName} 监控已销毁`)}))}}const ln=new Map;function un(e){var t=this;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!i())return;if(T(n,"__MIRROR_VERSION__")||console.warn("[Mirror] 检测到更高版本正在运行，当前版本将继续工作但建议统一版本"),!e||"string"!=typeof e)return void console.warn("[Mirror] 实例名称必须是有效的字符串");if(nn.has(e))return console.warn(`[Mirror] 实例 ${e} 已存在`),nn.get(e);if(window[e])return void console.warn(`[Mirror] 警告: 全局变量 ${e} 已存在，为避免冲突将不创建该实例`);on.set(e,r);const o=an(e),a={name:e,init:function(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return s(t,void 0,void 0,(function*(){try{const t=N({},r),o=N({},n),i=N(N(t,o),{instanceName:e});on.set(e,i);let s=ln.get(e);return s&&(yield s.destroy()),s=new cn(e,i),ln.set(e,s),yield s.initialize(),console.info(`[Mirror] 实例 ${e} 初始化完成`,i),Promise.resolve()}catch(t){throw console.error(`[Mirror] 实例 ${e} 初始化失败:`,t),t}}))},destroy:()=>s(this,void 0,void 0,(function*(){const t=ln.get(e);t&&(yield t.destroy(),ln.delete(e)),on.delete(e),nn.delete(e),window[e]&&delete window[e],console.info(`[Mirror] 实例 ${e} 已销毁`)})),techReportPb:o.techReportPb,customReportPb:o.customReportPb,pbReportPv:o.pbReportPv,changePbOptions:o.changePbOptions,canBatchTechReport:o.canBatchTechReport,customPerformanceQuota:o.customPerformanceQuota,exclusiveBisReport:o.exclusiveBisReport,trackLogReport:o.trackLogReport,trackCustomLog:o.trackCustomLog,trackGetLog:o.trackGetLog,_mirrorHandleErrorReport:o._mirrorHandleErrorReport,errorBoundary:o.errorBoundary};return nn.set(e,a),window[e]=a,console.info(`[Mirror] 创建实例: ${e}`),a}function dn(e){return nn.get(e)}function hn(){return Array.from(nn.keys())}const fn=l(),pn="__MIRROR_CONFIG__";function mn(){return T(n,"__MIRROR_VERSION__")}function gn(e){i()&&mn()&&(fn.isInited||(fn.isInited=!0,fn.mirrorInitMode||(fn.mirrorInitMode=q.DEFAULT),B(e).then((()=>s(this,void 0,void 0,(function*(){var t;yield yt();(yield Be.before(H.INIT,e))&&((null===(t=null==e?void 0:e.config)||void 0===t?void 0:t.isMonitorMethod)&&(tn.init(),tn.startCheck()),en(null==e?void 0:e.config),st(),Be.after(H.INIT,e),console.info("%c bili-fe-mirror %c v"+n+" ","padding: 2px 6px; border-radius: 3px 0 0 3px; color: #fff; background: #FF6699; font-weight: bold;","padding: 2px 6px; border-radius: 0 3px 3px 0; color: #fff; background: #FF9999; font-weight: bold;"))})))).catch((e=>{console.warn(e)}))))}i()&&function(){var e;if(!i())return;const t="__MIRROR_REPORT__";function r(e,t){window[e]||(window[e]=t)}r("__INITIAL_MIRROR__",gn);const n={techReportPb:xr,customReportPb:jr,pbReportPv:$r,changePbOptions:Ar,canBatchTechReport:Br,customPerformanceQuota:Hr,exclusiveBisReport:Dr,trackLogReport:Fr,trackCustomLog:Ur,trackGetLog:Wr,_mirrorHandleErrorReport:qr,errorBoundary:Gr,createInstance:un,getInstance:dn,getAllInstances:hn};if(window[t]){const e=window[t];Object.assign(e,n)}else r(t,n);if(r("biliMirror",Object.assign({},n)),r("__MIRROR_CREATE_INSTANCE__",un),window[pn]&&m.isObject(window[pn])){const t=window[pn];(null===(e=t.config)||void 0===e?void 0:e.isAutoInit)&&(!fn.mirrorInitMode&&(fn.mirrorInitMode=q.AUTO),gn(t))}}();var vn={SDK_NAME:r,SDK_VERSION:n,init:gn,install:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!mn())return;if(e.version&&e.version.startsWith("3"))if(e.config&&"object"==typeof e.config&&"errorHandler"in e.config){const t=e.config.errorHandler;e.config.errorHandler=function(e,r,n){if(kr.handleError(e),t)try{t.call(this,e,r,n)}catch(e){console.error("[Mirror] Vue 3 原始错误处理器执行失败:",e)}console.error("[Vue Error]",e)}}else if("function"==typeof e.createApp){const t=e.createApp;e.createApp=function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];const o=t.apply(this,r),i=o.config.errorHandler;return o.config.errorHandler=function(e,t,r){if(kr.handleError(e),i)try{i.call(this,e,t,r)}catch(e){console.error("[Mirror] Vue 3 原始错误处理器执行失败:",e)}console.error("[Vue Error]",e)},o}}else console.warn("[Mirror] 检测到 Vue 3 环境，但无法自动设置错误处理器"),console.warn("[Mirror] 请手动在应用实例上设置: app.config.errorHandler = (err) => { window.__MIRROR_REPORT__._mirrorHandleErrorReport(err); console.error(err); }");else{const t=e.config.errorHandler;e.config.errorHandler=function(e,r,n){if(kr.handleError(e),t)try{t.call(this,e,r,n)}catch(e){console.error("[Mirror] Vue 2 原始错误处理器执行失败:",e)}console.error("[Vue Error]",e)}}gn(t)},createInstance:un,getInstance:dn,getAllInstances:hn,errorBoundary:Gr};const{techReportPb:wn,customReportPb:yn,pbReportPv:bn,changePbOptions:Rn,canBatchTechReport:En,customPerformanceQuota:In,exclusiveBisReport:On,trackLogReport:Sn,trackCustomLog:_n,trackGetLog:Nn}=Kr,Pn=jr;e.canBatchTechReport=En,e.changePbOptions=Rn,e.createInstance=un,e.customPerformanceQuota=In,e.customReport=Pn,e.customReportPb=yn,e.default=vn,e.exclusiveBisReport=On,e.getAllInstances=hn,e.getInstance=dn,e.pbReportPv=bn,e.techReportPb=wn,e.trackCustomLog=_n,e.trackGetLog=Nn,e.trackLogReport=Sn,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=biliMirror.umd.mini.js.map
